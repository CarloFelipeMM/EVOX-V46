<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Evox - Agenda Profissional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Define a fonte Inter para todo o corpo do documento */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--gray-100);
            color: #333;
            margin: 0;
            padding: 0;
            -webkit-text-size-adjust: 100%;
            height: 100vh; /* Garante que o body ocupe 100% da viewport */
            /* overflow: hidden; */ /* Removido para permitir rolagem no main se necessário */
            display: flex;
            flex-direction: column;
        }
        /* Estilos para a barra de rolagem personalizada */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* === Estilos Globais do Cadastro de Pacientes === */
        :root {
            --primary: #000;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-700: #374151;
            --red-500: #ef4444;
            --green-500: #10b981;
            --blue-500: #3b82f6;
        }

        /* === Container Principal === */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* === Logo e Slogan === */
        .logo-container {
            text-align: center;
            margin: 1rem 0;
        }

        .logo-svg {
            width: 160px;
            height: auto;
        }

        .slogan {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary);
            margin-top: 0.5rem;
        }

        /* === Botões === */
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            border: none;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #333;
        }

        .btn-outline {
            background-color: white;
            border: 1px solid var(--gray-200);
            color: var(--gray-700);
        }

        .btn-outline:hover {
            background-color: var(--gray-100);
        }

        .btn-danger {
            background-color: var(--red-500);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn-success {
            background-color: var(--green-500);
            color: white;
        }

        .btn-success:hover {
            background-color: #059669;
        }

        .btn-info {
            background-color: var(--blue-500);
            color: white;
        }

        .btn-info:hover {
            background-color: #2563eb;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        /* === Cards === */
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 1.25rem;
            margin-bottom: 1.25rem;
        }

        /* === Formulários === */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-family: 'Poppins', sans-serif;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23374151' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
        }

        .textarea-field {
            min-height: 100px;
            resize: vertical;
        }

        /* === Tabela de Pacientes === */
        .patients-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.25rem;
            font-size: 0.85rem;
        }

        .patients-table th,
        .patients-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .patients-table th {
            font-weight: 600;
            background-color: var(--gray-100);
        }

        .patients-table tr:hover {
            background-color: var(--gray-100);
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center; /* Alinha os itens verticalmente */
        }

        /* === Telefones === */
        .phone-container {
            margin-bottom: 0.5rem;
        }

        .phone-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .phone-row select {
            flex: 1;
        }

        .phone-row input {
            flex: 3;
        }

        .add-phone-btn {
            margin-top: 0.5rem;
            padding: 0.5rem;
            font-size: 0.75rem;
        }

        /* === Barra de Busca === */
        .search-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.25rem;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .search-select {
            width: 150px;
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        /* === Backup Controls === */
        .backup-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            justify-content: flex-end;
        }

        /* === Modais === */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            padding: 1rem;
            box-sizing: border-box;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 1.25rem;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-700);
        }

        .modal-body {
            margin-bottom: 1.25rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        /* === Grid de Formulário === */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .form-full-width {
            grid-column: span 2;
        }

        /* === Print Styles === */
        @media print {
            /* Esconde tudo o que não for o iframe de impressão */
            body > *:not(#printIframe) {
                display: none !important;
            }

            /* Estilos para o iframe de impressão, tornando-o o único visível */
            #printIframe {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                border: none;
                z-index: 9999; /* Garante que ele esteja no topo */
                display: block; /* Garante que o iframe seja visível */
            }

            /* Estilos aplicados DENTRO do iframe para o conteúdo a ser impresso */
            .print-content-iframe-body {
                font-family: 'Inter', sans-serif;
                margin: 0;
                padding: 20px;
                color: #333;
            }

            .patient-info, .form-print-section {
                margin-bottom: 1.5rem;
                border-bottom: 1px solid #ddd;
                padding-bottom: 1rem;
                page-break-inside: avoid; /* Evita quebra de página dentro da info do paciente/seção do form */
            }
            .patient-info h3, .form-print-section h3 {
                margin-top: 0;
                color: #000;
            }
            .patient-info-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            .patient-info-item {
                margin-bottom: 0.5rem;
            }
            .patient-info-label {
                font-weight: 600;
                display: inline-block;
                min-width: 120px;
            }
            /* Estilos específicos para perguntas e respostas do formulário na impressão */
            .form-question-print {
                margin-bottom: 1rem;
                border: 1px solid #eee;
                padding: 0.75rem;
                border-radius: 4px;
                page-break-inside: avoid;
            }
            .form-question-print p {
                margin: 0;
            }
            .form-question-print .question-text {
                font-weight: 600;
                color: #333;
                margin-bottom: 0.5rem;
            }
            .form-question-print .answer-text {
                margin-left: 1rem;
                color: #555;
            }
        }


        /* === Responsividade === */
        @media (max-width: 768px) {
            /* EM TELAS MENORES: */
            .main-nav {
                display: none; /* Esconde a navegação normal */
            }
            .hamburger-menu {
                display: block; /* Mostra o menu hambúrguer */
            }
            /* Ajusta o cabeçalho para acomodar o menu hambúrguer */
            header {
                justify-content: space-between;
            }

            .agenda-layout {
                flex-direction: column; /* Empilha as colunas da agenda */
            }
            .agenda-layout > div {
                width: 100%; /* Ocupa a largura total */
                margin-right: 0; /* Remove margem extra */
                margin-bottom: 1rem; /* Adiciona espaço entre as seções */
            }
            .agenda-layout > div:last-child {
                margin-bottom: 0;
            }
        }
        /* EM TELAS MAIORES: */
        @media (min-width: 769px) {
            .main-nav {
                display: flex !important; /* Força a exibição da navegação normal */
            }
            .hamburger-menu {
                display: none !important; /* Esconde o menu hambúrguer */
            }
        }


        @media (max-width: 480px) {
            .container {
                padding: 0.75rem;
            }

            .card {
                padding: 1rem;
            }

            .modal-content {
                padding: 0.75rem;
            }

            .phone-row {
                flex-direction: column;
                gap: 0.5rem;
            }

            .phone-row select,
            .phone-row input {
                width: 100%;
            }

            .modal-footer {
                flex-direction: column;
                gap: 0.5rem;
            }

            .modal-footer .btn {
                width: 100%;
            }
        }

        /* Estilo para horários ocupados */
        .time-slot.occupied {
            background-color: #fefcbf; /* Amarelo claro */
            color: #92400e; /* Texto mais escuro */
            font-weight: 500;
        }

        /* Estilo para o dia selecionado no calendário */
        .calendar-day.selected {
            background-color: #000;
            color: white;
            font-weight: bold;
        }

        /* Estilo para dias com agendamento no calendário */
        .calendar-day.has-appointment {
            background-color: #bfdbfe; /* blue-200 */
            color: #1e40af; /* blue-800 */
            font-weight: bold;
        }
        .calendar-day.has-appointment.selected {
             background-color: #000;
             color: white;
        }


        /* Estilo para pacientes na lista de seleção */
        .patient-select-item {
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .patient-select-item:hover {
            background-color: #f3f4f6;
        }

        /* Estilos específicos para o editor de formulários */
        .form-editor-question {
            background-color: #fff;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .form-editor-question-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .form-editor-question-actions button {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.25rem;
        }

        .form-editor-question-type-select {
            width: auto;
            margin-bottom: 0.5rem;
        }

        .form-editor-options-container div {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .form-editor-options-container input[type="text"] {
            flex-grow: 1;
        }

        .form-editor-add-option-btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
        }

        /* Adicionado para rolagem APENAS nas perguntas do formulário */
        #questionsContainer {
            max-height: calc(100vh - 400px); /* Ajuste a altura para que apenas as perguntas rolem */
            overflow-y: auto; /* Adiciona barra de rolagem vertical quando necessário */
            padding-right: 0.5rem; /* Espaçamento para a barra de rolagem */
        }

        /* Estilos para os botões de status do agendamento */
        .status-btn {
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
            border-radius: 0.3rem;
            margin-left: 0.5rem;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .status-btn.confirmed {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
            border-color: #34d399; /* green-400 */
        }

        .status-btn.absence {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
            border-color: #f87171; /* red-400 */
        }

        .status-btn:hover {
            opacity: 0.8;
        }

        /* Estilos para o gerenciador de exercícios */
        #therapyView .slogan {
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 1.25rem; /* 20px */
            color: #333;
            margin-top: 0.5rem;
        }
        #therapyView .descricao-limitada {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #therapyView .button-group {
            display: flex;
            gap: 0.5rem;
        }
        @media (max-width: 640px) {
            #therapyView .button-group {
                flex-direction: column;
            }
            #therapyView .button-group button {
                width: 100%;
            }
            #therapyView .slogan {
                font-size: 1rem; /* 16px */
            }
        }

        /* Estilos para o menu hambúrguer */
        .hamburger-menu {
            display: none; /* Escondido por padrão em telas maiores, ativado via @media */
            cursor: pointer;
            padding: 0.5rem;
            z-index: 1001; /* Acima do overlay */
        }

        .hamburger-menu svg {
            width: 24px;
            height: 24px;
            color: var(--gray-600);
        }

        .sidebar-menu {
            position: fixed;
            top: 0;
            right: -250px; /* Escondido à direita */
            width: 250px;
            height: 100%;
            background-color: white;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
            transition: right 0.3s ease-in-out;
            z-index: 1000;
            padding-top: 4rem; /* Espaço para o cabeçalho */
            display: flex;
            flex-direction: column;
        }

        .sidebar-menu.open {
            right: 0; /* Visível */
        }

        .sidebar-menu a {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            color: var(--gray-700);
            font-weight: 500;
            display: block;
            text-decoration: none;
        }

        .sidebar-menu a:hover {
            background-color: var(--gray-100);
        }

        .sidebar-overlay {
            display: none; /* Escondido por padrão */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Ajustes para telas pequenas */
        @media (max-width: 768px) {
            .main-nav {
                display: none; /* Esconde a navegação normal */
            }
            .hamburger-menu {
                display: block; /* Mostra o menu hambúrguer */
            }
            /* Ajusta o cabeçalho para acomodar o menu hambúrguer */
            header {
                justify-content: space-between;
            }
            .agenda-layout {
                flex-direction: column; /* Empilha as colunas da agenda */
            }
            .agenda-layout > div {
                width: 100%; /* Ocupa a largura total */
                margin-right: 0; /* Remove margem extra */
                margin-bottom: 1rem; /* Adiciona espaço entre as seções */
            }
            .agenda-layout > div:last-child {
                margin-bottom: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
    <header class="bg-white shadow-md p-4 flex justify-between items-center">
        <div class="flex items-center">
            <img src="https://placehold.co/150x50/FFFFFF/000000?text=Logo+Evox" alt="Logo Evox" class="h-8 w-auto">
        </div>
        <nav class="main-nav flex space-x-6 text-gray-600 font-medium">
            <a href="#" id="openAgendaLink" class="hover:text-blue-600">Agenda</a>
            <a href="#" class="hover:text-blue-600" id="openProfissionalLink">Profissional</a> <a href="#" id="openPatientModalLink" class="hover:text-blue-600">Pacientes</a>
            <a href="#" id="openFormsLink" class="hover:text-blue-600">Formulários</a>
            <a href="#" id="openTherapyLink" class="hover:text-blue-600">Terapia</a>
        </nav>
        <div class="flex items-center space-x-4">
            <button class="hamburger-menu" id="hamburgerMenuBtn">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                </svg>
            </button>
        </div>
    </header>

    <div class="sidebar-menu" id="sidebarMenu">
        <a href="#" id="sidebarAgendaLink">Agenda</a>
        <a href="#" id="sidebarProfissionalLink">Profissional</a> <a href="#" id="sidebarPacientesLink">Pacientes</a>
        <a href="#" id="sidebarFormulariosLink">Formulários</a>
        <a href="#" id="sidebarTerapiaLink">Terapia</a>
        <hr class="my-2 border-gray-200"> <a href="#" id="sidebarConfiguracoesLink">Configurações</a>
        <a href="#" id="sidebarAjudaSuporteLink">Ajuda e Suporte</a>
        <a href="#" id="sidebarPoliticaPrivacidadeLink">Política de Privacidade</a>
        <a href="#" id="sidebarTermosUsoLink">Termos de Uso</a>
        <a href="#" id="sidebarSairLink">Sair</a>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <main class="flex flex-1 p-4 overflow-y-auto">
        <div id="agendaView" class="flex flex-1 flex-col lg:flex-row agenda-layout"> <div class="w-full lg:w-3/5 bg-white rounded-lg shadow-md p-4 mr-4 flex flex-col flex-1"> <h2 class="text-lg font-semibold text-gray-700 mb-4">Horários para <span id="selectedDateDisplay"></span></h2>
                <div id="timeSlotsContainer" class="flex-1 overflow-y-auto space-y-2">
                    </div>
            </div>

            <div class="w-full lg:w-2/5 bg-white rounded-lg shadow-md p-6 flex flex-col flex-1"> <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center space-x-2">
                        <div id="prevMonthBtn" class="p-2 rounded-full hover:bg-gray-200 cursor-pointer">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </div>
                        <span id="currentMonthYear" class="text-xl font-semibold text-gray-800"></span>
                        <div id="nextMonthBtn" class="p-2 rounded-full hover:bg-gray-200 cursor-pointer">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-7 gap-2 text-center text-sm font-medium text-gray-500 mb-2">
                    <div>D</div> <div>S</div>
                    <div>T</div>
                    <div>Q</div>
                    <div>Q</div>
                    <div>S</div>
                    <div>S</div>
                </div>

                <div id="calendarDays" class="grid grid-cols-7 gap-2 text-center text-gray-800">
                    </div>
            </div>
        </div>

        <div id="patientListView" class="flex flex-1 flex-col hidden h-full">
            <div class="container w-full">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem;">
                        <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">Cadastro de Pacientes</h2>
                        <button id="openModalBtn" class="btn btn-primary">Novo Paciente</button>
                    </div>

                    <div class="search-container">
                        <input type="text" id="searchInput" class="search-input" placeholder="Buscar pacientes...">
                        <select id="searchFilter" class="search-select">
                            <option value="all">Todos os campos</option>
                            <option value="id">ID</option>
                            <option value="name">Nome</option>
                            <option value="phone">Telefone</option>
                            <option value="healthInsurance">Convênio</option>
                            <option value="cpf">CPF</option>
                        </select>
                        <button id="searchBtn" class="btn btn-primary">Buscar</button>
                        <button id="clearSearchBtn" class="btn btn-outline">Limpar</button>
                    </div>

                    <table class="patients-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Idade</th>
                                <th>Sexo</th>
                                <th>Telefone</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="patientsList">
                            </tbody>
                    </table>

                    <div class="backup-controls">
                        <button id="exportBackupBtn" class="btn btn-info btn-sm">Exportar Backup</button>
                        <button id="importBackupBtn" class="btn btn-success btn-sm">Importar Backup</button>
                        <input type="file" id="backupFileInput" accept=".json" style="display: none;">
                    </div>
                </div>
            </div>
        </div>

        <div id="formsView" class="flex flex-1 flex-col hidden h-full">
            <div class="container w-full">
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-700">Meus Formulários</h2>
                        <button id="createNewFormBtn" class="btn btn-primary">Novo Formulário</button>
                    </div>
                    <div class="search-container mb-4">
                        <input type="text" id="formSearchInput" class="search-input" placeholder="Buscar formulários...">
                        <button id="formSearchBtn" class="btn btn-primary">Buscar</button>
                        <button id="formClearSearchBtn" class="btn btn-outline">Limpar</button>
                    </div>
                    <div id="formsList" class="space-y-3 max-h-96 overflow-y-auto">
                        </div>
                    <div class="backup-controls mt-4">
                        <button id="exportFormsBackupBtn" class="btn btn-info btn-sm">Exportar Formulários</button>
                        <button id="importFormsBackupBtn" class="btn btn-success btn-sm">Importar Formulários</button>
                        <input type="file" id="formsBackupFileInput" accept=".json" style="display: none;">
                    </div>
                </div>
            </div>
        </div>

        <div id="formEditorView" class="flex flex-1 flex-col hidden h-full">
            <div class="container w-full">
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-700" id="formEditorTitle">Formulário sem título</h2>
                        <div class="flex space-x-2">
                            <button id="previewFormBtn" class="btn btn-outline">Visualizar</button>
                            <button id="saveFormDefinitionBtn" class="btn btn-primary">Salvar Formulário</button>
                            <button id="closeFormEditorBtn" class="btn btn-outline">Fechar Editor</button>
                        </div>
                    </div>
                    <input type="text" id="formFileName" class="form-control mb-2 text-lg font-semibold" placeholder="Nome do arquivo (ex: Avaliação X)">
                    <input type="text" id="formMainTitle" class="form-control mb-2 text-2xl font-bold" placeholder="Título principal (ex: Avaliação X)">
                    <textarea id="formDescription" class="form-control textarea-field mb-4" placeholder="Descrição do formulário"></textarea>

                    <div id="questionsContainer" class="space-y-4 mb-4">
                        </div>

                    <button id="addQuestionBtn" class="btn btn-outline w-full">+ Adicionar Pergunta</button>
                </div>
            </div>
        </div>

        <div id="therapyView" class="flex flex-1 flex-col hidden h-full p-4 sm:p-6">
            <div class="max-w-5xl mx-auto mb-6 flex flex-col items-center"> <img src="https://placehold.co/150x50/FFFFFF/000000?text=Logo+Evox" alt="Logo Evox" class="w-48 h-auto"> <div class="slogan">Gestão de exercícios terapêuticos</div>
            </div>

            <div class="max-w-5xl mx-auto bg-white shadow-lg rounded-xl p-4 sm:p-6"> <div class="flex flex-col sm:flex-row justify-between gap-3 mb-4">
                    <button class="bg-black text-white px-4 py-3 rounded-lg hover:bg-gray-800 text-sm sm:text-base" onclick="therapyApp.abrirModalPaciente()">Paciente</button>
                    <button class="bg-black text-white px-4 py-3 rounded-lg hover:bg-gray-800 text-sm sm:text-base" onclick="therapyApp.abrirModalBusca()">Buscar Exercício</button>
                </div>
                
                <h1 class="text-xl sm:text-2xl font-bold mb-4 text-center">Exercícios</h1>
                
                <div id="therapyPatientDisplay" class="text-center text-lg font-semibold text-gray-700 mb-4 hidden"></div>

                <div>
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-2 mb-3">
                        <label class="font-semibold text-sm sm:text-base">Exercícios Selecionados</label>
                        <div class="flex space-x-2">
                            <button class="text-black hover:underline text-xs sm:text-sm" onclick="therapyApp.copiarTexto()">Copiar</button>
                            <button class="text-black hover:underline text-xs sm:text-sm" onclick="therapyApp.imprimirTexto()">Imprimir</button>
                            <button class="text-black hover:underline text-xs sm:text-sm" onclick="therapyApp.removerSelecionado()">Excluir</button>
                            <button class="text-black hover:underline text-xs sm:text-sm font-semibold" onclick="therapyApp.saveSelectedTherapy()">Salvar Terapia</button>
                        </div>
                    </div>
                    <div class="relative border border-gray-300 rounded-lg bg-gray-50 p-4 h-[50vh] sm:h-80 overflow-y-auto shadow-inner" id="therapyExercicioSelecionado">
                        <div class="text-center py-4 text-gray-500">Nenhum exercício selecionado</div>
                    </div>
                </div>
            </div>

            <div class="max-w-3xl mx-auto mt-6 text-center text-xs text-gray-500">
                © 2025 Carlo Felipe Mendes Melo. Todos os direitos reservados.<br>
                Contato: (61) 9.9934-2573
            </div>

            <div class="fixed inset-0 bg-black bg-opacity50 flex items-center justify-center hidden modal" id="therapyModalPaciente">
                <div class="bg-white rounded-xl shadow-lg w-full max-w-md mx-2">
                    <div class="p-4 sm:p-6">
                        <h2 class="text-lg sm:text-xl font-semibold mb-4">Nome do Paciente</h2>
                        <input class="w-full px-3 py-3 border rounded-lg text-sm sm:text-base" id="therapyNomePaciente" placeholder="Digite o nome do paciente..." type="text"/>
                        <div class="flex flex-col sm:flex-row justify-end gap-2 mt-4 button-group">
                            <button class="bg-black text-white px-4 py-2 rounded-lg hover:bg-gray-800 text-sm sm:text-base" onclick="therapyApp.salvarPaciente()">Salvar</button>
                            <button class="text-gray-700 hover:underline text-sm sm:text-base" onclick="therapyApp.fecharModalPaciente()">Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden modal" id="therapyModalBusca">
                <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl mx-2">
                    <div class="p-4 sm:p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-center gap-2 mb-4">
                            <h2 class="text-lg sm:text-xl font-semibold">Exercícios Cadastrados</h2>
                            <div class="flex space-x-2">
                                <button class="text-xs sm:text-sm text-white bg-black px-3 py-1 rounded-lg hover:bg-gray-800" onclick="therapyApp.abrirModalCadastro()">Novo</button>
                                <button class="text-xs sm:text-sm text-white bg-black px-3 py-1 rounded-lg hover:bg-gray-800" onclick="therapyApp.fecharModalBusca()">Fechar</button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <input class="w-full px-3 py-2 border rounded-lg text-sm sm:text-base" id="therapyCampoBusca" oninput="therapyApp.filtrarExercicios()" placeholder="Buscar exercício..." type="text"/>
                        </div>
                        <div class="max-h-[60vh] overflow-y-auto space-y-2" id="therapyListaExercicios"></div>
                    </div>
                </div>
            </div>

            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden modal" id="therapyModalCadastro">
                <div class="bg-white rounded-xl shadow-lg w-full max-w-lg mx-2">
                    <div class="p-4 sm:p-6">
                        <h2 class="text-lg sm:text-xl font-semibold mb-4">Novo Exercício</h2>
                        <div class="space-y-3">
                            <input class="w-full px-3 py-2 border rounded-lg text-sm sm:text-base" id="therapyCadNome" placeholder="Nome do exercício" type="text"/>
                            <textarea class="w-full px-3 py-2 border rounded-lg text-sm sm:text-base" id="therapyCadDescricao" placeholder="Descrição" rows="4"></textarea>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-end gap-2 mt-4 button-group">
                            <button class="bg-black text-white px-4 py-2 rounded-lg hover:bg-gray-800 text-sm sm:text-base" onclick="therapyApp.salvarNovoExercicio()">Salvar</button>
                            <button class="text-gray-700 hover:underline text-sm sm:text-base" onclick="therapyApp.fecharModalCadastro()">Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden modal" id="therapyModalInformacoes">
                <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl mx-2">
                    <div class="p-4 sm:p-6">
                        <h2 class="text-lg sm:text-xl font-semibold mb-4">Informações Adicionais</h2>
                        <textarea class="w-full px-3 py-2 border rounded-lg text-sm sm:text-base" id="therapyTextoInformacoes" rows="8" placeholder="Digite informações adicionais..."></textarea>
                        <div class="flex flex-col sm:flex-row justify-end gap-2 mt-4 button-group">
                            <button class="bg-black text-white px-4 py-2 rounded-lg hover:bg-gray-800 text-sm sm:text-base" onclick="therapyApp.salvarInformacoes()">Salvar</button>
                            <button class="text-gray-700 hover:underline text-sm sm:text-base" onclick="therapyApp.fecharModalInformacoes()">Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden modal" id="therapyModalDetalhesExercicio">
                <div class="bg-white rounded-xl shadow-lg w-full max-w-md mx-2">
                    <div class="p-4 sm:p-6">
                        <h2 class="text-lg sm:text-xl font-semibold mb-4" id="therapyTituloModalExercicio">Exercício</h2>
                        <div class="space-y-2">
                            <input class="w-full px-3 py-2 border rounded-lg text-sm sm:text-base" id="therapyInputSeries" placeholder="Séries (opcional)" type="number"/>
                            <input class="w-full px-3 py-2 border rounded-lg text-sm sm:text-base" id="therapyInputRepeticoes" placeholder="Repetições (opcional)" type="text"/>
                            <input class="w-full px-3 py-2 border rounded-lg text-sm sm:text-base" id="therapyInputDescanso" placeholder="Descanso (opcional)" type="text"/>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-end gap-2 mt-4 button-group">
                            <button class="bg-black text-white px-4 py-2 rounded-lg hover:bg-gray-800 text-sm sm:text-base" id="therapyBotaoEnviarExercicio">Enviar</button>
                            <button class="text-gray-700 hover:underline text-sm sm:text-base" onclick="therapyApp.fecharModalDetalhes()">Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="max-w-3xl mx-auto mt-4 sm:mt-6 flex justify-center space-x-8">
                <button class="text-gray-600 hover:text-black transition-colors" title="Backup" onclick="therapyApp.fazerBackup()">
                    <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                    </svg>
                </button>
                <button class="text-gray-600 hover:text-black transition-colors" title="Importar Backup" onclick="therapyApp.importarBackup()">
                    <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                    </svg>
                </button>
            </div>
        </div>
    </main>

    <div id="patientModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="patientModalTitle">Cadastro de Paciente</h3>
                <button class="modal-close" id="closePatientModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="patientFormSection">
                    <form id="patientForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="patientId" class="form-label">Número de Identificação</label>
                                <input type="text" id="patientId" class="form-control" readonly>
                            </div>

                            <div class="form-group">
                                <label for="registrationDate" class="form-label">Data de Cadastro</label>
                                <input type="date" id="registrationDate" class="form-control">
                            </div>

                            <div class="form-group form-full-width">
                                <label for="fullName" class="form-label">Nome Completo *</label>
                                <input type="text" id="fullName" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label for="birthDate" class="form-label">Data de Nascimento *</label>
                                <input type="date" id="birthDate" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label for="age" class="form-label">Idade</label>
                                <input type="text" id="age" class="form-control" readonly>
                            </div>

                            <div class="form-group">
                                <label for="gender" class="form-label">Sexo *</label>
                                <select id="gender" class="form-control form-select" required>
                                    <option value="">Selecione</option>
                                    <option value="masculino">Masculino</option>
                                    <option value="feminino">Feminino</option>
                                    <option value="outro">Outro</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="maritalStatus" class="form-label">Estado Civil</label>
                                <select id="maritalStatus" class="form-control form-select">
                                    <option value="">Selecione</option>
                                    <option value="solteiro">Solteiro(a)</option>
                                    <option value="casado">Casado(a)</option>
                                    <option value="divorciado">Divorciado(a)</option>
                                    <option value="viuvo">Viúvo(a)</option>
                                    <option value="separado">Separado(a)</option>
                                    <option value="uniao_estavel">União Estável</option>
                                </select>
                            </div>

                            <div class="form-group form-full-width" id="phonesContainer">
                                <label class="form-label">Telefones *</label>
                                <div class="phone-container" id="phoneTemplate">
                                    <div class="phone-row">
                                        <select class="form-control form-select phone-type">
                                            <option value="celular">Celular</option>
                                            <option value="fixo">Fixo</option>
                                            <option value="whatsapp">WhatsApp</option>
                                            <option value="trabalho">Trabalho</option>
                                        </select>
                                        <input type="tel" class="form-control phone-number" placeholder="Número com DDD">
                                        <button type="button" class="btn btn-danger remove-phone-btn">Remover</button>
                                    </div>
                                </div>
                                <button type="button" id="addPhoneBtn" class="btn btn-outline add-phone-btn">+ Adicionar Telefone</button>
                            </div>

                            <div class="form-group">
                                <label for="email" class="form-label">E-mail</label>
                                <input type="email" id="email" class="form-control">
                            </div>

                            <div class="form-group">
                                <label for="rg" class="form-label">RG</label>
                                <input type="text" id="rg" class="form-control">
                            </div>

                            <div class="form-group">
                                <label for="cpf" class="form-label">CPF</label>
                                <input type="text" id="cpf" class="form-control">
                            </div>

                            <div class="form-group">
                                <label for="healthInsurance" class="form-label">Convênio</label>
                                <input type="text" id="healthInsurance" class="form-control">
                            </div>

                            <div class="form-group">
                                <label for="insuranceNumber" class="form-label">Número da Carteirinha</label>
                                <input type="text" id="insuranceNumber" class="form-control">
                            </div>

                            <div class="form-group">
                                <label for="profession" class="form-label">Profissão</label>
                                <input type="text" id="profession" class="form-control">
                            </div>

                            <div class="form-group">
                                <label for="weight" class="form-label">Peso (kg)</label>
                                <input type="number" id="weight" class="form-control" min="0" step="0.1">
                            </div>

                            <div class="form-group">
                                <label for="height" class="form-label">Altura (cm)</label>
                                <input type="number" id="height" class="form-control" min="0">
                            </div>

                            <div class="form-group">
                                <label for="responsible" class="form-label">Responsável Legal</label>
                                <input type="text" id="responsible" class="form-control">
                            </div>

                            <div class="form-group">
                                <label for="provenance" class="form-label">Procedência</label>
                                <input type="text" id="provenance" class="form-control" placeholder="Ex: Encaminhamento, cidade, instituição">
                            </div>

                            <div class="form-group form-full-width">
                                <label for="notes" class="form-label">Observações Gerais</label>
                                <textarea id="notes" class="form-control textarea-field"></textarea>
                            </div>

                            <div class="form-group form-full-width">
                                <label for="alerts" class="form-label">Avisos Importantes</label>
                                <textarea id="alerts" class="form-control textarea-field" placeholder="Alertas ou mensagens importantes sobre o paciente"></textarea>
                            </div>
                        </div>
                    </form>
                </div>

                <div id="patientSelectSection" class="hidden">
                    <h4 class="text-lg font-semibold text-gray-700 mb-4">Selecionar Paciente Existente</h4>
                    <input type="text" id="patientSelectSearch" class="form-control mb-4" placeholder="Buscar paciente para associar...">
                    <div id="existingPatientsList" class="max-h-60 overflow-y-auto border border-gray-200 rounded-md">
                        </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="cancelBtn" class="btn btn-outline">Cancelar</button>
                <button type="button" id="saveBtn" class="btn btn-primary">Salvar</button>
                <button type="button" id="printBtn" class="btn btn-success no-print">Imprimir</button>
            </div>
        </div>
    </div>

    <div id="printModal" class="modal-overlay" style="display: none;"> <div class="modal-content print-content">
            <div class="modal-header no-print">
                <h3 class="modal-title" id="printModalActualTitle"></h3>
                <button class="modal-close" id="closePrintModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="printContentArea"></div>
            </div>
            <div class="modal-footer no-print">
                <button type="button" id="closePrintBtn" class="btn btn-outline">Fechar</button>
                <button type="button" id="printNowBtn" class="btn btn-primary">Imprimir</button>
            </div>
        </div>
    </div>
    <div id="messageModal" class="modal-overlay">
        <div class="modal-content max-w-sm">
            <div class="modal-header">
                <h3 class="modal-title" id="messageModalTitle"></h3>
                <button class="modal-close" id="closeMessageModalBtn">&times;</button>
            </div>
            <div class="modal-body" id="messageModalBody"></div>
            <div class="modal-footer" id="messageModalFooter">
                <button type="button" id="messageModalConfirmBtn" class="btn btn-primary">OK</button>
                <button type="button" id="messageModalCancelBtn" class="btn btn-outline" style="display:none;">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="recordModal" class="modal-overlay">
        <div class="modal-content max-w-md">
            <div class="modal-header">
                <h3 class="modal-title" id="recordModalTitle">Prontuário do Paciente</h3>
                <button class="modal-close" id="closeRecordModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="space-y-3" id="recordOptionsContainer">
                    <div class="p-3 bg-gray-100 rounded-md cursor-pointer hover:bg-gray-200" data-record-type="anamnese">Prontuário</div>
                    <div class="p-3 bg-gray-100 rounded-md cursor-pointer hover:bg-gray-200" data-record-type="exercicios">Exercícios Prescritos</div>
                    <div class="p-3 bg-gray-100 rounded-md cursor-pointer hover:bg-gray-200" data-record-type="anexos">Anexos</div>
                </div>
            </div>
        </div>
    </div>

    <div id="therapyPatientRecordModal" class="modal-overlay">
        <div class="modal-content max-w-2xl">
            <div class="modal-header">
                <h3 class="modal-title" id="therapyPatientRecordModalTitle">Terapias de <span id="therapyRecordPatientName"></span></h3>
                <button class="modal-close" id="closeTherapyPatientRecordModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="flex border-b border-gray-200 mb-4">
                    <button id="tabSavedTherapies" class="py-2 px-4 text-sm font-medium border-b-2 border-transparent hover:border-gray-300 focus:outline-none focus:border-blue-500">Terapias Salvas</button>
                    <button id="tabNewTherapy" class="py-2 px-4 text-sm font-medium border-b-2 border-transparent hover:border-gray-300 focus:outline-none focus:border-blue-500">Nova Terapia</button>
                </div>

                <div id="savedTherapiesContent">
                    <div id="patientSavedTherapiesList" class="max-h-60 overflow-y-auto border border-gray-200 rounded-md">
                        </div>
                </div>

                <div id="newTherapyContent" class="hidden">
                    <p class="text-gray-700 mb-4">Clique no botão abaixo para ir para o gerenciador de exercícios e criar uma nova terapia para este paciente.</p>
                    <button id="goToTherapyViewBtn" class="btn btn-primary">Ir para Gerenciador de Exercícios</button>
                </div>
            </div>
        </div>
    </div>

    <div id="applyFormModal" class="modal-overlay">
        <div class="modal-content max-w-2xl">
            <div class="modal-header">
                <h3 class="modal-title" id="applyFormModalTitle">Formulários de <span id="currentPatientNameForForms"></span></h3>
                <button class="modal-close" id="closeApplyFormModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="flex border-b border-gray-200 mb-4">
                    <button id="tabApplyForm" class="py-2 px-4 text-sm font-medium border-b-2 border-transparent hover:border-gray-300 focus:outline-none focus:border-blue-500">Aplicar Formulário</button>
                    <button id="tabAppliedForms" class="py-2 px-4 text-sm font-medium border-b-2 border-transparent hover:border-gray-300 focus:outline-none focus:border-blue-500">Formulários Aplicados</button>
                </div>

                <div id="applyFormContent">
                    <h4 class="text-lg font-semibold text-gray-700 mb-4">Buscar e Aplicar Formulário</h4>
                    <input type="text" id="formSearchInputForApply" class="form-control mb-4" placeholder="Buscar formulários salvos...">
                    <div id="availableFormsList" class="max-h-60 overflow-y-auto border border-gray-200 rounded-md">
                        </div>
                </div>

                <div id="appliedFormsContent" class="hidden">
                    <h4 class="text-lg font-semibold text-gray-700 mb-4">Formulários Aplicados a este Paciente</h4>
                    <div id="patientAppliedFormsList" class="max-h-60 overflow-y-auto border border-gray-200 rounded-md">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <div id="fillFormModal" class="modal-overlay">
        <div class="modal-content max-w-3xl">
            <div class="modal-header">
                <h3 class="modal-title" id="fillFormModalTitle">Preencher Formulário</h3>
                <button class="modal-close" id="closeFillFormModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <h4 class="text-xl font-bold mb-2" id="fillFormMainTitle"></h4>
                <p class="text-gray-600 mb-4" id="fillFormDescription"></p>
                <form id="fillFormContentArea" class="space-y-4">
                    </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="cancelFillFormBtn" class="btn btn-outline">Cancelar</button>
                <button type="button" id="saveFilledFormBtn" class="btn btn-primary">Salvar Respostas</button>
                <button type="button" id="printFilledFormBtn" class="btn btn-success no-print">Imprimir</button>
            </div>
        </div>
    </div>

    <div id="previewOnlyFormModal" class="modal-overlay">
        <div class="modal-content max-w-3xl">
            <div class="modal-header">
                <h3 class="modal-title" id="previewOnlyFormModalTitle">Visualização do Formulário</h3>
                <button class="modal-close" id="closePreviewOnlyFormModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <h4 class="text-xl font-bold mb-2" id="previewOnlyFormMainTitle"></h4>
                <p class="text-gray-600 mb-4" id="previewOnlyFormDescription"></p>
                <div id="previewOnlyFormContentArea" class="space-y-4">
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="closePreviewOnlyBtn" class="btn btn-outline">Fechar</button>
            </div>
        </div>
    </div>

    <div id="sessionManagementModal" class="modal-overlay">
        <div class="modal-content max-w-md">
            <div class="modal-header">
                <h3 class="modal-title" id="sessionManagementModalTitle">Gerenciar Sessões de <span id="sessionPatientName"></span></h3>
                <button class="modal-close" id="closeSessionManagementModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="totalSessions" class="form-label">Total de Sessões</label>
                    <input type="number" id="totalSessions" class="form-control" min="1">
                </div>
                <div class="form-group">
                    <label for="sessionsPerWeek" class="form-label">Sessões por Semana</label>
                    <input type="number" id="sessionsPerWeek" class="form-control" min="1">
                </div>
                <div class="form-group">
                    <label for="sessionStartDate" class="form-label">Data de Início</label>
                    <input type="date" id="sessionStartDate" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Horários Fixos (Dia da Semana e Hora)</label>
                    <div id="fixedTimesContainer" class="space-y-2">
                        </div>
                    <button type="button" id="addFixedTimeBtn" class="btn btn-outline btn-sm mt-2">+ Adicionar Horário Fixo</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="cancelSessionManagementBtn" class="btn btn-outline">Cancelar</button>
                <button type="button" id="saveSessionManagementBtn" class="btn btn-primary">Salvar e Agendar</button>
            </div>
        </div>
    </div>


    <script>
        // Variáveis globais
        let patients = [];
        let forms = []; // Nova variável para armazenar as definições dos formulários
        let appliedForms = []; // Nova variável para armazenar as instâncias de formulários preenchidos por paciente
        let savedPatientTherapies = []; // Nova variável para armazenar terapias salvas por paciente
        let currentPatientId = null;
        let isEditing = false;
        let appointments = {}; // Estrutura para armazenar agendamentos: { 'YYYY-MM-DD': { 'HH:MM': { patientId: '...', patientName: '...', status: { confirmed: false, absence: false } } } }
        let currentEditingForm = null; // Armazena o formulário que está sendo editado no editor
        let currentAppliedFormInstance = null; // Armazena a instância do formulário que está sendo preenchido/visualizado
        let currentFillingFormDefinition = null; // Armazena a definição do formulário que está sendo preenchido/visualizado
        let currentSessionPatientId = null; // ID do paciente para o modal de gerenciamento de sessões
        let therapyCurrentPatientId = null; // ID do paciente para o gerenciador de exercícios

        // Variáveis de controle da agenda
        let currentDate = new Date(); // Mês/Ano atualmente exibido no calendário
        let selectedDate = new Date(); // Dia selecionado no calendário
        let selectedTimeSlotElement = null; // Elemento do DOM do horário clicado

        // Elementos do DOM (Views principais)
        const agendaView = document.getElementById('agendaView');
        const patientListView = document.getElementById('patientListView');
        const formsView = document.getElementById('formsView'); // Nova view para listagem de formulários
        const formEditorView = document.getElementById('formEditorView'); // Nova view para o editor de formulários
        const therapyView = document.getElementById('therapyView'); // Nova view para o gerenciador de exercícios

        // Elementos do DOM (Navegação do cabeçalho)
        const openAgendaLink = document.getElementById('openAgendaLink');
        const openProfissionalLink = document.getElementById('openProfissionalLink'); // Mantido
        const openPatientModalLink = document.getElementById('openPatientModalLink');
        const openFormsLink = document.getElementById('openFormsLink'); // Novo link para formulários
        const openTherapyLink = document.getElementById('openTherapyLink'); // Novo link para Terapia

        // Elementos do DOM (Agenda)
        const timeSlotsContainer = document.getElementById('timeSlotsContainer');
        const selectedDateDisplay = document.getElementById('selectedDateDisplay');
        const currentMonthYear = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const calendarDays = document.getElementById('calendarDays');

        // Elementos do DOM (Cadastro de Pacientes - Modais e Listagem)
        const patientModal = document.getElementById('patientModal');
        const patientModalTitle = document.getElementById('patientModalTitle');
        const patientFormSection = document.getElementById('patientFormSection');
        const patientSelectSection = document.getElementById('patientSelectSection');
        const existingPatientsList = document.getElementById('existingPatientsList');
        const patientSelectSearch = document.getElementById('patientSelectSearch');

        const printModal = document.getElementById('printModal');
        const printModalActualTitle = document.getElementById('printModalActualTitle'); // Novo elemento para o título real do modal de impressão
        const openModalBtn = document.getElementById('openModalBtn'); // Botão "Novo Paciente" dentro do card de listagem
        const closePatientModalBtn = document.getElementById('closePatientModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveBtn = document.getElementById('saveBtn');
        const printBtn = document.getElementById('printBtn');
        const closePrintModalBtn = document.getElementById('closePrintModalBtn');
        const closePrintBtn = document.getElementById('closePrintBtn');
        const printNowBtn = document.getElementById('printNowBtn');
        const patientForm = document.getElementById('patientForm');
        const patientsList = document.getElementById('patientsList');
        const printContentArea = document.getElementById('printContentArea'); // Mudado para uma área genérica

        // Elementos da busca de pacientes
        const searchInput = document.getElementById('searchInput');
        const searchFilter = document.getElementById('searchFilter');
        const searchBtn = document.getElementById('searchBtn');
        const clearSearchBtn = document.getElementById('clearSearchBtn');

        // Elementos do backup de pacientes
        const exportBackupBtn = document.getElementById('exportBackupBtn');
        const importBackupBtn = document.getElementById('importBackupBtn');
        const backupFileInput = document.getElementById('backupFileInput');

        // Elementos do formulário de paciente
        const patientId = document.getElementById('patientId');
        const registrationDate = document.getElementById('registrationDate');
        const fullName = document.getElementById('fullName');
        const birthDate = document.getElementById('birthDate');
        const age = document.getElementById('age');
        const gender = document.getElementById('gender');
        const maritalStatus = document.getElementById('maritalStatus');
        const email = document.getElementById('email');
        const rg = document.getElementById('rg');
        const cpf = document.getElementById('cpf');
        const healthInsurance = document.getElementById('healthInsurance');
        const insuranceNumber = document.getElementById('insuranceNumber');
        const profession = document.getElementById('profession');
        const weight = document.getElementById('weight');
        const height = document.getElementById('height');
        const responsible = document.getElementById('responsible');
        const provenance = document.getElementById('provenance');
        const notes = document.getElementById('notes');
        const alerts = document.getElementById('alerts');
        const phonesContainer = document.getElementById('phonesContainer');
        const phoneTemplate = document.getElementById('phoneTemplate');
        const addPhoneBtn = document.getElementById('addPhoneBtn');

        // Elementos do Modal de Mensagens/Confirmações
        const messageModal = document.getElementById('messageModal');
        const messageModalTitle = document.getElementById('messageModalTitle');
        const messageModalBody = document.getElementById('messageModalBody');
        const messageModalConfirmBtn = document.getElementById('messageModalConfirmBtn');
        const messageModalCancelBtn = document.getElementById('messageModalCancelBtn');
        const closeMessageModalBtn = document.getElementById('closeMessageModalBtn');

        // Elementos do Modal de Prontuário
        const recordModal = document.getElementById('recordModal');
        const recordModalTitle = document.getElementById('recordModalTitle');
        const closeRecordModalBtn = document.getElementById('closeRecordModalBtn');
        const recordOptionsContainer = document.getElementById('recordOptionsContainer');

        // Elementos da View de Formulários (listagem)
        const createNewFormBtn = document.getElementById('createNewFormBtn');
        const formsList = document.getElementById('formsList');
        const formSearchInput = document.getElementById('formSearchInput');
        const formSearchBtn = document.getElementById('formSearchBtn');
        const formClearSearchBtn = document.getElementById('formClearSearchBtn');
        const exportFormsBackupBtn = document.getElementById('exportFormsBackupBtn');
        const importFormsBackupBtn = document.getElementById('importFormsBackupBtn');
        const formsBackupFileInput = document.getElementById('formsBackupFileInput');

        // Elementos da View do Editor de Formulários
        const formEditorTitle = document.getElementById('formEditorTitle');
        const formFileName = document.getElementById('formFileName');
        const formMainTitle = document.getElementById('formMainTitle');
        const formDescription = document.getElementById('formDescription');
        const formEditorContentScroll = document.getElementById('formEditorContentScroll');
        const questionsContainer = document.getElementById('questionsContainer');
        const addQuestionBtn = document.getElementById('addQuestionBtn');
        const saveFormDefinitionBtn = document.getElementById('saveFormDefinitionBtn');
        const previewFormBtn = document.getElementById('previewFormBtn');
        const closeFormEditorBtn = document.getElementById('closeFormEditorBtn');

        // Elementos do Modal de Aplicação/Visualização de Formulários (Prontuário)
        const applyFormModal = document.getElementById('applyFormModal');
        const applyFormModalTitle = document.getElementById('applyFormModalTitle');
        const closeApplyFormModalBtn = document.getElementById('closeApplyFormModalBtn');
        const tabApplyForm = document.getElementById('tabApplyForm');
        const tabAppliedForms = document.getElementById('tabAppliedForms');
        const applyFormContent = document.getElementById('applyFormContent');
        const appliedFormsContent = document.getElementById('appliedFormsContent');
        const formSearchInputForApply = document.getElementById('formSearchInputForApply');
        const availableFormsList = document.getElementById('availableFormsList');
        const patientAppliedFormsList = document.getElementById('patientAppliedFormsList');
        const currentPatientNameForForms = document.getElementById('currentPatientNameForForms');

        // Elementos do Modal para Preencher/Visualizar Formulário Aplicado
        const fillFormModal = document.getElementById('fillFormModal');
        const fillFormModalTitle = document.getElementById('fillFormModalTitle');
        const closeFillFormModalBtn = document.getElementById('closeFillFormModalBtn');
        const fillFormMainTitle = document.getElementById('fillFormMainTitle');
        const fillFormDescription = document.getElementById('fillFormDescription');
        const fillFormContentArea = document.getElementById('fillFormContentArea');
        const cancelFillFormBtn = document.getElementById('cancelFillFormBtn');
        const saveFilledFormBtn = document.getElementById('saveFilledFormBtn');
        const printFilledFormBtn = document.getElementById('printFilledFormBtn');

        // Elementos do Modal para Visualização de Formulário (Preview)
        const previewOnlyFormModal = document.getElementById('previewOnlyFormModal');
        const previewOnlyFormModalTitle = document.getElementById('previewOnlyFormModalTitle');
        const closePreviewOnlyFormModalBtn = document.getElementById('closePreviewOnlyFormModalBtn');
        const previewOnlyFormMainTitle = document.getElementById('previewOnlyFormMainTitle');
        const previewOnlyFormDescription = document.getElementById('previewOnlyFormDescription');
        const previewOnlyFormContentArea = document.getElementById('previewOnlyFormContentArea');
        const closePreviewOnlyBtn = document.getElementById('closePreviewOnlyBtn');

        // Elementos do Modal de Gerenciamento de Sessões
        const sessionManagementModal = document.getElementById('sessionManagementModal');
        const sessionManagementModalTitle = document.getElementById('sessionManagementModalTitle');
        const sessionPatientName = document.getElementById('sessionPatientName');
        const closeSessionManagementModalBtn = document.getElementById('closeSessionManagementModalBtn');
        const totalSessionsInput = document.getElementById('totalSessions');
        const sessionsPerWeekInput = document.getElementById('sessionsPerWeek');
        const sessionStartDateInput = document.getElementById('sessionStartDate');
        const fixedTimesContainer = document.getElementById('fixedTimesContainer');
        const addFixedTimeBtn = document.getElementById('addFixedTimeBtn');
        const cancelSessionManagementBtn = document.getElementById('cancelSessionManagementBtn');
        const saveSessionManagementBtn = document.getElementById('saveSessionManagementBtn');

        // Elementos e variáveis do Gerenciador de Exercícios (Therapy App)
        const therapyPatientDisplay = document.getElementById('therapyPatientDisplay');
        const therapyExercicioSelecionado = document.getElementById('therapyExercicioSelecionado');
        const therapyModalPaciente = document.getElementById('therapyModalPaciente');
        const therapyNomePaciente = document.getElementById('therapyNomePaciente');
        const therapyModalBusca = document.getElementById('therapyModalBusca');
        const therapyCampoBusca = document.getElementById('therapyCampoBusca');
        const therapyListaExercicios = document.getElementById('therapyListaExercicios');
        const therapyModalCadastro = document.getElementById('therapyModalCadastro');
        const therapyCadNome = document.getElementById('therapyCadNome');
        const therapyCadDescricao = document.getElementById('therapyCadDescricao');
        const therapyModalInformacoes = document.getElementById('therapyModalInformacoes');
        const therapyTextoInformacoes = document.getElementById('therapyTextoInformacoes');
        const therapyModalDetalhesExercicio = document.getElementById('therapyModalDetalhesExercicio');
        const therapyTituloModalExercicio = document.getElementById('therapyTituloModalExercicio');
        const therapyInputSeries = document.getElementById('therapyInputSeries');
        const therapyInputRepeticoes = document.getElementById('therapyInputRepeticoes');
        const therapyInputDescanso = document.getElementById('therapyInputDescanso');
        const therapyBotaoEnviarExercicio = document.getElementById('therapyBotaoEnviarExercicio');

        // Novos elementos para o modal de prontuário de terapias
        const therapyPatientRecordModal = document.getElementById('therapyPatientRecordModal');
        const therapyPatientRecordModalTitle = document.getElementById('therapyPatientRecordModalTitle');
        const therapyRecordPatientName = document.getElementById('therapyRecordPatientName');
        const closeTherapyPatientRecordModalBtn = document.getElementById('closeTherapyPatientRecordModalBtn');
        const tabSavedTherapies = document.getElementById('tabSavedTherapies');
        const tabNewTherapy = document.getElementById('tabNewTherapy');
        const savedTherapiesContent = document.getElementById('savedTherapiesContent');
        const newTherapyContent = document.getElementById('newTherapyContent');
        const patientSavedTherapiesList = document.getElementById('patientSavedTherapiesList');
        const goToTherapyViewBtn = document.getElementById('goToTherapyViewBtn');

        // Elementos do menu hambúrguer
        const hamburgerMenuBtn = document.getElementById('hamburgerMenuBtn');
        const sidebarMenu = document.getElementById('sidebarMenu');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const sidebarAgendaLink = document.getElementById('sidebarAgendaLink');
        const sidebarProfissionalLink = document.getElementById('sidebarProfissionalLink');
        const sidebarPacientesLink = document.getElementById('sidebarPacientesLink');
        const sidebarFormulariosLink = document.getElementById('sidebarFormulariosLink');
        const sidebarTerapiaLink = document.getElementById('sidebarTerapiaLink');
        // Novos links adicionados
        const sidebarConfiguracoesLink = document.getElementById('sidebarConfiguracoesLink');
        const sidebarAjudaSuporteLink = document.getElementById('sidebarAjudaSuporteLink');
        const sidebarPoliticaPrivacidadeLink = document.getElementById('sidebarPoliticaPrivacidadeLink');
        const sidebarTermosUsoLink = document.getElementById('sidebarTermosUsoLink');
        const sidebarSairLink = document.getElementById('sidebarSairLink');


        // Funções para Modais de Mensagens e Confirmações
        function showAlert(message, title = 'Aviso') {
            return new Promise(resolve => {
                messageModalTitle.textContent = title;
                messageModalBody.textContent = message;
                messageModalCancelBtn.style.display = 'none'; // Esconde o botão de cancelar para alertas
                messageModalConfirmBtn.textContent = 'OK';

                const closeHandler = () => {
                    messageModal.classList.remove('active');
                    messageModalConfirmBtn.removeEventListener('click', confirmHandler);
                    closeMessageModalBtn.removeEventListener('click', closeHandler);
                    resolve(true);
                };

                const confirmHandler = () => {
                    messageModal.classList.remove('active');
                    messageModalConfirmBtn.removeEventListener('click', confirmHandler);
                    closeMessageModalBtn.removeEventListener('click', closeHandler);
                    resolve(true);
                };

                messageModalConfirmBtn.addEventListener('click', confirmHandler);
                closeMessageModalBtn.addEventListener('click', closeHandler);
                messageModal.classList.add('active');
            });
        }

        function showConfirm(message, title = 'Confirmação') {
            return new Promise(resolve => {
                messageModalTitle.textContent = title;
                messageModalBody.textContent = message;
                messageModalCancelBtn.style.display = 'inline-block'; // Mostra o botão de cancelar para confirmações
                messageModalConfirmBtn.textContent = 'Confirmar';

                const confirmHandler = () => {
                    messageModal.classList.remove('active');
                    messageModalConfirmBtn.removeEventListener('click', confirmHandler);
                    messageModalCancelBtn.removeEventListener('click', cancelHandler);
                    closeMessageModalBtn.removeEventListener('click', closeHandler);
                    resolve(true);
                };

                const cancelHandler = () => {
                    messageModal.classList.remove('active');
                    messageModalConfirmBtn.removeEventListener('click', confirmHandler);
                    messageModalCancelBtn.removeEventListener('click', cancelHandler);
                    closeMessageModalBtn.removeEventListener('click', closeHandler);
                    resolve(false);
                };

                const closeHandler = () => {
                    messageModal.classList.remove('active');
                    messageModalConfirmBtn.removeEventListener('click', confirmHandler);
                    messageModalCancelBtn.removeEventListener('click', cancelHandler);
                    closeMessageModalBtn.removeEventListener('click', closeHandler);
                    resolve(false);
                };

                messageModalConfirmBtn.addEventListener('click', confirmHandler);
                messageModalCancelBtn.addEventListener('click', cancelHandler);
                closeMessageModalBtn.addEventListener('click', closeHandler);
                messageModal.classList.add('active');
            });
        }


        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Carrega pacientes do localStorage se existirem
            const savedPatients = localStorage.getItem('patients');
            if (savedPatients) {
                patients = JSON.parse(savedPatients);
            }
            // Carrega agendamentos do localStorage
            const savedAppointments = localStorage.getItem('appointments');
            if (savedAppointments) {
                appointments = JSON.parse(savedAppointments);
            }
            // Carrega formulários do localStorage
            const savedForms = localStorage.getItem('forms');
            if (savedForms) {
                forms = JSON.parse(savedForms);
            }
            // Carrega formulários preenchidos do localStorage
            const savedAppliedForms = localStorage.getItem('appliedForms');
            if (savedAppliedForms) {
                appliedForms = JSON.parse(savedAppliedForms);
            }
            // Carrega terapias salvas do localStorage
            const savedTherapiesData = localStorage.getItem('savedPatientTherapies');
            if (savedTherapiesData) {
                savedPatientTherapies = JSON.parse(savedTherapiesData);
            }

            // Configura a data de cadastro para hoje por padrão, mas permite edição
            const today = new Date();
            // Garante que a data selecionada seja o dia atual, no fuso horário local
            selectedDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            registrationDate.value = selectedDate.toISOString().split('T')[0];

            // Gera um novo ID para o paciente
            generatePatientId();

            // Remove o template de telefone inicial (se ainda existir no DOM)
            const phoneTemplateElement = document.getElementById('phoneTemplate');
            if (phoneTemplateElement) {
                phoneTemplateElement.remove();
            }

            // Adiciona o primeiro campo de telefone
            addPhoneField();

            // Renderiza o calendário e os horários iniciais
            renderCalendar();
            renderTimeSlots();

            // Inicializa o app de terapia
            therapyApp.init();
        });

        // Event Listeners (Navegação Principal)
        openPatientModalLink.addEventListener('click', function(e) {
            e.preventDefault();
            agendaView.classList.add('hidden');
            formsView.classList.add('hidden');
            formEditorView.classList.add('hidden');
            therapyView.classList.add('hidden'); // Esconde a view de terapia
            patientListView.classList.remove('hidden');
            renderPatientsList();
        });

        openAgendaLink.addEventListener('click', function(e) {
            e.preventDefault();
            patientListView.classList.add('hidden');
            formsView.classList.add('hidden');
            formEditorView.classList.add('hidden');
            therapyView.classList.add('hidden'); // Esconde a view de terapia
            agendaView.classList.remove('hidden');
            renderCalendar(); // Re-renderiza o calendário ao voltar para a agenda
            renderTimeSlots(); // Re-renderiza os horários para a data selecionada
        });

        openProfissionalLink.addEventListener('click', function(e) {
            e.preventDefault();
            showAlert('A funcionalidade "Profissional" será adicionada em breve!', 'Funcionalidade Futura');
        });

        openFormsLink.addEventListener('click', function(e) {
            e.preventDefault();
            agendaView.classList.add('hidden');
            patientListView.classList.add('hidden');
            formEditorView.classList.add('hidden');
            therapyView.classList.add('hidden'); // Esconde a view de terapia
            formsView.classList.remove('hidden');
            renderFormsList(); // Renderiza a lista de formulários
        });

        openTherapyLink.addEventListener('click', function(e) {
            e.preventDefault();
            agendaView.classList.add('hidden');
            patientListView.classList.add('hidden');
            formsView.classList.add('hidden');
            formEditorView.classList.add('hidden');
            therapyView.classList.remove('hidden'); // Mostra a view de terapia
            therapyApp.setPatient(null); // Limpa o paciente atual no app de terapia
        });

        // Eventos do menu hambúrguer
        hamburgerMenuBtn.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);
        sidebarAgendaLink.addEventListener('click', function(e) { e.preventDefault(); openAgendaLink.click(); closeSidebar(); }); // Fecha a sidebar
        sidebarProfissionalLink.addEventListener('click', function(e) { e.preventDefault(); showAlert('A funcionalidade "Profissional" será adicionada em breve!', 'Funcionalidade Futura'); closeSidebar(); }); // Fecha a sidebar
        sidebarPacientesLink.addEventListener('click', function(e) { e.preventDefault(); openPatientModalLink.click(); closeSidebar(); }); // Fecha a sidebar
        sidebarFormulariosLink.addEventListener('click', function(e) { e.preventDefault(); openFormsLink.click(); closeSidebar(); }); // Fecha a sidebar
        sidebarTerapiaLink.addEventListener('click', function(e) { e.preventDefault(); openTherapyLink.click(); closeSidebar(); }); // Fecha a sidebar

        // Novos event listeners para os itens do menu hambúrguer
        sidebarConfiguracoesLink.addEventListener('click', function(e) { e.preventDefault(); showAlert('A funcionalidade "Configurações" será adicionada em breve!', 'Funcionalidade Futura'); closeSidebar(); });
        sidebarAjudaSuporteLink.addEventListener('click', function(e) { e.preventDefault(); showAlert('A funcionalidade "Ajuda e Suporte" será adicionada em breve!', 'Funcionalidade Futura'); closeSidebar(); });
        sidebarPoliticaPrivacidadeLink.addEventListener('click', function(e) { e.preventDefault(); showAlert('A funcionalidade "Política de Privacidade" será adicionada em breve!', 'Funcionalidade Futura'); closeSidebar(); });
        sidebarTermosUsoLink.addEventListener('click', function(e) { e.preventDefault(); showAlert('A funcionalidade "Termos de Uso" será adicionada em breve!', 'Funcionalidade Futura'); closeSidebar(); });
        sidebarSairLink.addEventListener('click', async function(e) { // Marcado como async
            e.preventDefault();
            const confirmed = await showConfirm('Tem certeza que deseja sair?', 'Sair');
            if (confirmed) {
                // Implemente a lógica de logout aqui (ex: redirecionar para tela de login)
                showAlert('Você saiu da sua conta.', 'Sessão Encerrada');
                closeSidebar();
            }
        });


        function toggleSidebar() {
            sidebarMenu.classList.toggle('open');
            sidebarOverlay.classList.toggle('active');
        }

        function closeSidebar() {
            sidebarMenu.classList.remove('open');
            sidebarOverlay.classList.remove('active');
        }


        // Eventos do calendário
        prevMonthBtn.addEventListener('click', prevMonth);
        nextMonthBtn.addEventListener('click', nextMonth);

        openModalBtn.addEventListener('click', () => openPatientModal(null)); // Abrir modal para novo paciente
        closePatientModalBtn.addEventListener('click', closePatientModal);
        cancelBtn.addEventListener('click', closePatientModal);
        saveBtn.addEventListener('click', savePatient);
        printBtn.addEventListener('click', preparePrint);
        closePrintModalBtn.addEventListener('click', closePrintModal);
        closePrintBtn.addEventListener('click', closePrintModal); // Corrigido para fechar o modal de impressão
        printNowBtn.addEventListener('click', () => preparePrintContent(printContentArea.innerHTML, printModalActualTitle.textContent)); // Passa o HTML e o título

        // Busca de pacientes na listagem
        searchBtn.addEventListener('click', searchPatients);
        clearSearchBtn.addEventListener('click', clearSearch);
        searchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                searchPatients();
            }
        });

        // Busca de pacientes no modal de seleção
        patientSelectSearch.addEventListener('keyup', function() {
            renderExistingPatientsForSelection(patientSelectSearch.value);
        });

        // Backup de pacientes
        exportBackupBtn.addEventListener('click', exportBackup);
        importBackupBtn.addEventListener('click', triggerImportBackup);
        backupFileInput.addEventListener('change', importBackup);

        // Fechar modal ao clicar fora
        patientModal.addEventListener('click', (e) => {
            if (e.target === patientModal) {
                closePatientModal();
            }
        });

        printModal.addEventListener('click', (e) => {
            if (e.target === printModal) {
                closePrintModal();
            }
        });

        messageModal.addEventListener('click', (e) => {
            if (e.target === messageModal) {
                messageModal.classList.remove('active');
            }
        });

        // Eventos do Novo Modal de Prontuário
        closeRecordModalBtn.addEventListener('click', closeRecordModal);
        recordModal.addEventListener('click', (e) => {
            if (e.target === recordModal) {
                closeRecordModal();
            }
        });
        // Adicionar listeners para as opções do prontuário (Anamnese e Avaliação agora abrem o modal de formulários)
        recordOptionsContainer.querySelectorAll('div').forEach(option => {
            option.addEventListener('click', function() {
                const recordType = this.getAttribute('data-record-type');
                if (recordType === 'anamnese' || recordType === 'avaliacao') {
                    // MANTIDO: Abre o modal de aplicação de formulários
                    openApplyFormModal(currentPatientId, recordType);
                } else if (recordType === 'exercicios') {
                    // MODIFICADO: Abre o novo modal de terapias do paciente
                    openTherapyPatientRecordModal(currentPatientId);
                } else {
                    showAlert(`Você clicou em: ${this.textContent}. A funcionalidade será adicionada em breve!`, 'Funcionalidade Futura');
                    closeRecordModal();
                }
            });
        });

        // Eventos do Novo Modal de Terapias do Paciente
        closeTherapyPatientRecordModalBtn.addEventListener('click', () => therapyPatientRecordModal.classList.remove('active'));
        therapyPatientRecordModal.addEventListener('click', (e) => {
            if (e.target === therapyPatientRecordModal) {
                therapyPatientRecordModal.classList.remove('active');
            }
        });

        tabSavedTherapies.addEventListener('click', () => {
            tabSavedTherapies.classList.add('border-blue-500', 'text-blue-600');
            tabNewTherapy.classList.remove('border-blue-500', 'text-blue-600');
            savedTherapiesContent.classList.remove('hidden');
            newTherapyContent.classList.add('hidden');
            renderSavedTherapies(currentPatientId); // Renderiza as terapias salvas
        });

        tabNewTherapy.addEventListener('click', () => {
            tabNewTherapy.classList.add('border-blue-500', 'text-blue-600');
            tabSavedTherapies.classList.remove('border-blue-500', 'text-blue-600');
            newTherapyContent.classList.remove('hidden');
            savedTherapiesContent.classList.add('hidden');
        });

        goToTherapyViewBtn.addEventListener('click', () => {
            openTherapyAppForPatient(currentPatientId); // Abre o gerenciador de exercícios com o paciente selecionado
            therapyPatientRecordModal.classList.remove('active'); // Fecha o modal atual
        });

        // Calcular idade quando a data de nascimento é alterada
        birthDate.addEventListener('change', calculateAge);

        // Adicionar campo de telefone
        addPhoneBtn.addEventListener('click', addPhoneField);

        // --- Funções de Agenda ---

        function renderCalendar() {
            calendarDays.innerHTML = '';
            // Atualiza a exibição da data selecionada
            selectedDateDisplay.textContent = selectedDate.toLocaleDateString('pt-BR');
            currentMonthYear.textContent = currentDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // Dia da semana do primeiro dia do mês (0 = Dom, 1 = Seg...)
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            // Último dia do mês
            const lastDayOfMonth = new Date(year, month + 1, 0).getDate();
            // Último dia do mês anterior
            const lastDayOfPrevMonth = new Date(year, month, 0).getDate();

            // Preencher dias do mês anterior
            for (let i = firstDayOfMonth - 1; i >= 0; i--) {
                const day = lastDayOfPrevMonth - i;
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('p-2', 'rounded-full', 'text-gray-400');
                dayDiv.textContent = day;
                calendarDays.appendChild(dayDiv);
            }

            // Preencher dias do mês atual
            for (let day = 1; day <= lastDayOfMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('p-2', 'rounded-full', 'hover:bg-gray-200', 'cursor-pointer', 'calendar-day');
                dayDiv.textContent = day;
                const dayDate = new Date(year, month, day);
                // Usar toISOString().split('T')[0] para obtertoLocaleDateString
                const dayDateKey = dayDate.toISOString().split('T')[0];
                dayDiv.dataset.date = dayDateKey;

                // Marcar dia selecionado
                // Comparar apenas a parte da data, ignorando o tempo, para evitar problemas de fuso horário
                const selectedDayFormatted = selectedDate.toISOString().split('T')[0];
                if (dayDateKey === selectedDayFormatted) {
                    dayDiv.classList.add('selected');
                }

                // Marcar dias com agendamento
                if (appointments[dayDateKey] && Object.keys(appointments[dayDateKey]).length > 0) {
                    dayDiv.classList.add('has-appointment');
                }


                dayDiv.addEventListener('click', function() {
                    // Remover seleção do dia anterior
                    const prevSelected = document.querySelector('.calendar-day.selected');
                    if (prevSelected) {
                        prevSelected.classList.remove('selected');
                    }
                    // Adicionar seleção ao novo dia
                    this.classList.add('selected');
                    // Cria uma nova data, garantindo que seja no fuso horário local do dia clicado
                    const [year, month, day] = this.dataset.date.split('-').map(Number);
                    selectedDate = new Date(year, month - 1, day); // Month is 0-indexed in Date constructor
                    selectedDateDisplay.textContent = selectedDate.toLocaleDateString('pt-BR');
                    renderTimeSlots(); // Atualiza os horários para o dia selecionado
                });
                calendarDays.appendChild(dayDiv);
            }

            // Preencher dias do próximo mês (para completar a grade de 6 semanas)
            const totalDaysDisplayed = firstDayOfMonth + lastDayOfMonth;
            const remainingCells = 42 - totalDaysDisplayed; // 6 semanas * 7 dias = 42 células
            for (let i = 1; i <= remainingCells; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('p-2', 'rounded-full', 'text-gray-400');
                dayDiv.textContent = i;
                calendarDays.appendChild(dayDiv);
            }
        }

        function prevMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function renderTimeSlots() {
            timeSlotsContainer.innerHTML = '';
            // Usa o toISOString().split('T')[0] para obtertoLocaleDateString, que é o formato da chave no 'appointments'
            const selectedDateKey = selectedDate.toISOString().split('T')[0];
            selectedDateDisplay.textContent = selectedDate.toLocaleDateString('pt-BR'); // Atualiza a exibição da data
            const dailyAppointments = appointments[selectedDateKey] || {};

            for (let h = 0; h < 24; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const hour = String(h).padStart(2, '0');
                    const minute = String(m).padStart(2, '0');
                    const time = `${hour}:${minute}`;

                    const timeSlotDiv = document.createElement('div');
                    timeSlotDiv.classList.add('p-2', 'border-b', 'border-gray-200', 'cursor-pointer', 'time-slot');
                    timeSlotDiv.dataset.time = time;
                    timeSlotDiv.dataset.date = selectedDateKey;

                    let displayContent = time;

                    // Verifica se há um agendamento para este horário
                    if (dailyAppointments[time]) {
                        const patientInfo = dailyAppointments[time];
                        timeSlotDiv.classList.add('occupied'); // Adiciona classe para estilo de ocupado

                        displayContent = `
                            <div class="flex items-center justify-between">
                                <span class="flex items-center">
                                    ${time} - ${patientInfo.patientName}
                                    <button class="ml-2 text-gray-500 hover:text-blue-600 view-record-btn" data-patient-id="${patientInfo.patientId}" title="Ver Prontuário">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                    </button>
                                    <button class="ml-1 text-gray-500 hover:text-blue-600 manage-sessions-btn" data-patient-id="${patientInfo.patientId}" title="Gerenciar Sessões">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                    </button>
                                    <button class="ml-1 text-red-500 hover:text-red-700 delete-appointment-btn" data-date="${selectedDateKey}" data-time="${time}" title="Excluir Agendamento">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    </button>
                                </span>
                                <span class="flex items-center">
                                    <button class="status-btn ${patientInfo.status && patientInfo.status.confirmed ? 'confirmed' : ''}" data-status-type="confirmed" data-date="${selectedDateKey}" data-time="${time}" title="Confirmado">
                                        Confirmado
                                    </button>
                                    <button class="status-btn ${patientInfo.status && patientInfo.status.absence ? 'absence' : ''}" data-status-type="absence" data-date="${selectedDateKey}" data-time="${time}" title="Ausência">
                                        Ausência
                                    </button>
                                </span>
                            </div>
                        `;
                    }

                    timeSlotDiv.innerHTML = displayContent; // Use innerHTML para renderizar o SVG e botões

                    // Adiciona listener para abrir o prontuário
                    const viewRecordBtn = timeSlotDiv.querySelector('.view-record-btn');
                    if (viewRecordBtn) {
                        viewRecordBtn.addEventListener('click', function(e) {
                            e.stopPropagation(); // Impede que o clique no botão ative o timeSlotDiv pai
                            openRecordModal(this.dataset.patientId);
                        });
                    }

                    // Adiciona listener para gerenciar sessões
                    const manageSessionsBtn = timeSlotDiv.querySelector('.manage-sessions-btn');
                    if (manageSessionsBtn) {
                        manageSessionsBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            openSessionManagementModal(this.dataset.patientId);
                        });
                    }

                    // Adiciona listener para excluir agendamento
                    const deleteAppointmentBtn = timeSlotDiv.querySelector('.delete-appointment-btn');
                    if (deleteAppointmentBtn) {
                        deleteAppointmentBtn.addEventListener('click', async function(e) {
                            e.stopPropagation();
                            const confirmed = await showConfirm('Tem certeza que deseja excluir este agendamento?', 'Excluir Agendamento');
                            if (confirmed) {
                                deleteAppointment(this.dataset.date, this.dataset.time);
                            }
                        });
                    }


                    // Adiciona listeners para os botões de status
                    timeSlotDiv.querySelectorAll('.status-btn').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.stopPropagation(); // Impede que o clique no botão ative o timeSlotDiv pai
                            toggleAppointmentStatus(this.dataset.date, this.dataset.time, this.dataset.statusType);
                        });
                    });

                    // Adiciona listener para o timeSlotDiv (para agendar/editar)
                    timeSlotDiv.addEventListener('click', function() {
                        selectedTimeSlotElement = this; // Armazena o elemento do horário clicado
                        // Só abre o modal de seleção se não houver agendamento
                        if (!dailyAppointments[time]) {
                            openPatientModal(this); // Abre o modal no modo de seleção de paciente
                        }
                    });

                    timeSlotsContainer.appendChild(timeSlotDiv);
                }
            }
        }

        async function deleteAppointment(dateKey, timeKey) {
            if (appointments[dateKey] && appointments[dateKey][timeKey]) {
                delete appointments[dateKey][timeKey];
                if (Object.keys(appointments[dateKey]).length === 0) {
                    delete appointments[dateKey]; // Remove a entrada da data se não houver mais agendamentos
                }
                localStorage.setItem('appointments', JSON.stringify(appointments));
                renderTimeSlots();
                renderCalendar(); // Re-renderiza o calendário para atualizar as marcações de dias com agendamento
                await showAlert('Agendamento excluído com sucesso!', 'Sucesso');
            }
        }


        function toggleAppointmentStatus(dateKey, timeKey, statusType) {
            if (!appointments[dateKey] || !appointments[dateKey][timeKey]) {
                showAlert('Agendamento não encontrado para atualizar o status.', 'Erro');
                return;
            }

            const appt = appointments[dateKey][timeKey];
            if (!appt.status) {
                appt.status = { confirmed: false, absence: false };
            }

            // Lógica para alternar o status
            if (statusType === 'confirmed') {
                appt.status.confirmed = !appt.status.confirmed;
                if (appt.status.confirmed) {
                    appt.status.absence = false; // Se confirmado, não pode ser ausente
                }
            } else if (statusType === 'absence') {
                appt.status.absence = !appt.status.absence;
                if (appt.status.absence) {
                    appt.status.confirmed = false; // Se ausente, não pode ser confirmado
                }
            }

            localStorage.setItem('appointments', JSON.stringify(appointments));
            renderTimeSlots(); // Re-renderiza para atualizar a UI
        }


        // --- Funções de Cadastro de Pacientes (adaptadas) ---

        function openPatientModal(timeSlot = null) {
            if (timeSlot) {
                // Modo de seleção/associação de paciente
                patientModalTitle.textContent = `Associar Paciente a ${selectedDate.toLocaleDateString('pt-BR')} às ${timeSlot.dataset.time}`;
                patientFormSection.classList.add('hidden');
                patientSelectSection.classList.remove('hidden');
                renderExistingPatientsForSelection(); // Carrega a lista de pacientes para seleção
                saveBtn.style.display = 'none'; // Esconde o botão Salvar do formulário
                printBtn.style.display = 'none'; // Esconde o botão Imprimir do formulário
            } else {
                // Modo de cadastro/edição de paciente
                patientModalTitle.textContent = 'Cadastro de Paciente';
                patientFormSection.classList.remove('hidden');
                patientSelectSection.classList.add('hidden');
                saveBtn.style.display = 'inline-block'; // Mostra o botão Salvar
                printBtn.style.display = 'inline-block'; // Mostra o botão Imprimir

                isEditing = false;
                currentPatientId = null;
                patientForm.reset();
                generatePatientId();

                const today = new Date();
                registrationDate.value = new Date(today.getFullYear(), today.getMonth(), today.getDate()).toISOString().split('T')[0];

                const phoneRows = phonesContainer.querySelectorAll('.phone-row');
                phoneRows.forEach(row => {
                    if (row !== phoneTemplate) row.remove();
                });
                addPhoneField();
            }
            patientModal.classList.add('active');
        }

        function closePatientModal() {
            patientModal.classList.remove('active');
            selectedTimeSlotElement = null; // Limpa o elemento de horário selecionado
        }

        function closeRecordModal() {
            recordModal.classList.remove('active');
        }

        function openRecordModal(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (patient) {
                currentPatientId = patientId; // Define o paciente atual para o prontuário
                recordModalTitle.textContent = `Prontuário de ${patient.fullName}`;
                recordModal.classList.add('active');
            } else {
                showAlert('Paciente não encontrado para abrir o prontuário.', 'Erro');
            }
        }

        // Função para abrir o aplicativo de terapia para um paciente específico
        function openTherapyAppForPatient(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (patient) {
                agendaView.classList.add('hidden');
                patientListView.classList.add('hidden');
                formsView.classList.add('hidden');
                formEditorView.classList.add('hidden');
                therapyView.classList.remove('hidden'); // Mostra a view de terapia
                therapyApp.setPatient(patient); // Define o paciente no app de terapia
                closeRecordModal(); // Fecha o modal de prontuário
            } else {
                showAlert('Paciente não encontrado.', 'Erro');
            }
        }

        // Função para abrir o novo modal de Terapias do Paciente
        function openTherapyPatientRecordModal(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) {
                showAlert('Paciente não encontrado para gerenciar terapias.', 'Erro');
                return;
            }
            currentPatientId = patientId; // Define o paciente atual para o modal
            therapyRecordPatientName.textContent = patient.fullName;

            // Ativa a aba de "Terapias Salvas" por padrão
            tabSavedTherapies.classList.add('border-blue-500', 'text-blue-600');
            tabNewTherapy.classList.remove('border-blue-500', 'text-blue-600');
            savedTherapiesContent.classList.remove('hidden');
            newTherapyContent.classList.add('hidden');

            renderSavedTherapies(patientId);
            therapyPatientRecordModal.classList.add('active');
            closeRecordModal(); // Fecha o modal de prontuário
        }

        // Função para renderizar as terapias salvas de um paciente
        function renderSavedTherapies(patientId) {
            patientSavedTherapiesList.innerHTML = '';
            const therapiesForPatient = savedPatientTherapies.filter(t => t.patientId === patientId);

            if (therapiesForPatient.length === 0) {
                patientSavedTherapiesList.innerHTML = `<div class="p-4 text-gray-500">Nenhuma terapia salva para este paciente.</div>`;
                return;
            }

            therapiesForPatient.forEach(therapy => {
                const therapyDiv = document.createElement('div');
                therapyDiv.classList.add('p-3', 'border-b', 'border-gray-200', 'flex', 'justify-between', 'items-center', 'space-x-2');
                therapyDiv.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-gray-800">Terapia de ${formatDate(therapy.date)}</h3>
                        <p class="text-sm text-gray-600">${therapy.exercises.length} exercício(s)</p>
                    </div>
                    <div class="flex space-x-2">
                        <button class="btn btn-outline btn-sm view-saved-therapy-btn" data-therapy-id="${therapy.id}">Visualizar</button>
                        <button class="btn btn-info btn-sm print-saved-therapy-btn" data-therapy-id="${therapy.id}">Imprimir</button>
                        <button class="btn btn-danger btn-sm delete-saved-therapy-btn" data-therapy-id="${therapy.id}">Excluir</button>
                    </div>
                `;
                patientSavedTherapiesList.appendChild(therapyDiv);
            });

            document.querySelectorAll('.view-saved-therapy-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const therapyId = this.dataset.therapyId;
                    const therapy = savedPatientTherapies.find(t => t.id === therapyId);
                    if (therapy) {
                        viewSavedTherapy(therapy);
                    }
                });
            });

            document.querySelectorAll('.print-saved-therapy-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const therapyId = this.dataset.therapyId;
                    const therapy = savedPatientTherapies.find(t => t.id === therapyId);
                    if (therapy) {
                        preparePrintContent(buildTherapyPrintHtml(therapy), "Impressão de Terapia");
                    }
                });
            });

            document.querySelectorAll('.delete-saved-therapy-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const therapyId = this.dataset.therapyId;
                    const confirmed = await showConfirm('Tem certeza que deseja excluir esta terapia?', 'Excluir Terapia');
                    if (confirmed) {
                        deleteSavedTherapy(therapyId);
                    }
                });
            });
        }

        // Função auxiliar para construir o HTML de impressão da terapia
        function buildTherapyPrintHtml(therapyInstance) {
            const patient = patients.find(p => p.id === therapyInstance.patientId);
            let contentHtml = `
                <div class="patient-info">
                    <h3>Terapia de Exercícios</h3>
                    <p class="text-sm text-gray-700">Paciente: ${patient ? patient.fullName : 'Paciente Desconhecido'} (ID: ${therapyInstance.patientId})</p>
                    <p class="text-sm text-gray-700">Data da Terapia: ${formatDate(therapyInstance.date)}</p>
                </div>
                <div class="mt-4">
                    <h3 class="text-xl font-semibold mb-3">Exercícios Prescritos:</h3>
            `;
            if (therapyInstance.exercises && therapyInstance.exercises.length > 0) {
                therapyInstance.exercises.forEach((ex, i) => {
                    contentHtml += `
                        <div class="mb-3 p-2 border border-gray-200 rounded-md">
                            <p class="font-medium text-gray-700 mb-1">${i + 1}. ${ex.nome}</p>
                            <p class="text-gray-800 ml-2">${ex.descricao.replace(/\n/g, '<br>')}</p>
                        </div>
                    `;
                });
            } else {
                contentHtml += `<p class="text-gray-500">Nenhum exercício nesta terapia.</p>`;
            }
            contentHtml += `</div>`;
            return contentHtml;
        }


        // Função para visualizar uma terapia salva
        function viewSavedTherapy(therapyInstance) {
            if (!therapyInstance) {
                showAlert('Terapia não encontrada.', 'Aviso');
                return;
            }
            printModalActualTitle.textContent = "Visualizar Terapia";
            printContentArea.innerHTML = buildTherapyPrintHtml(therapyInstance);
            printModal.classList.add('active'); // Abre o modal de visualização
        }

        // Função para imprimir uma terapia salva (reutiliza o modal de impressão)
        function printSavedTherapy(therapyInstance) {
            preparePrintContent(buildTherapyPrintHtml(therapyInstance), "Impressão de Terapia");
        }

        // Função para excluir uma terapia salva
        async function deleteSavedTherapy(therapyIdToDelete) {
            const confirmed = await showConfirm('Tem certeza que deseja excluir esta terapia?', 'Excluir Terapia');
            if (confirmed) {
                savedPatientTherapies = savedPatientTherapies.filter(t => t.id !== therapyIdToDelete);
                localStorage.setItem('savedPatientTherapies', JSON.stringify(savedPatientTherapies));
                renderSavedTherapies(currentPatientId); // Atualiza a lista
                await showAlert('Terapia excluída com sucesso!', 'Sucesso');
            }
        }


        function renderExistingPatientsForSelection(searchTerm = '') {
            existingPatientsList.innerHTML = '';
            const lowerCaseSearchTerm = searchTerm.toLowerCase();

            const filtered = patients.filter(patient =>
                patient.fullName.toLowerCase().includes(lowerCaseSearchTerm) ||
                patient.id.toLowerCase().includes(lowerCaseSearchTerm) ||
                (patient.cpf && patient.cpf.toLowerCase().includes(lowerCaseSearchTerm))
            );

            if (filtered.length === 0) {
                existingPatientsList.innerHTML = `<div class="p-4 text-gray-500">Nenhum paciente encontrado.</div>`;
                return;
            }

            filtered.forEach(patient => {
                const patientDiv = document.createElement('div');
                patientDiv.classList.add('patient-select-item');
                patientDiv.textContent = `${patient.fullName} (ID: ${patient.id})`;
                patientDiv.dataset.patientId = patient.id;
                patientDiv.dataset.patientName = patient.fullName;

                patientDiv.addEventListener('click', function() {
                    associatePatientToTimeSlot(this.dataset.patientId, this.dataset.patientName);
                });
                existingPatientsList.appendChild(patientDiv);
            });
        }

        function associatePatientToTimeSlot(patientId, patientName) {
            if (selectedTimeSlotElement) {
                const dateKey = selectedTimeSlotElement.dataset.date;
                const timeKey = selectedTimeSlotElement.dataset.time;

                if (!appointments[dateKey]) {
                    appointments[dateKey] = {};
                }

                // Inicializa o status para o novo agendamento
                appointments[dateKey][timeKey] = { patientId, patientName, status: { confirmed: false, absence: false } };
                localStorage.setItem('appointments', JSON.stringify(appointments));

                showAlert(`Paciente ${patientName} agendado para ${selectedDate.toLocaleDateString('pt-BR')} às ${timeKey}.`, 'Agendamento Confirmado');
                closePatientModal();
                renderTimeSlots(); // Re-renderiza para mostrar o ícone e botões de status
                renderCalendar(); // Re-renderiza o calendário para atualizar as marcações de dias com agendamento
            }
        }

        function closePrintModal() {
            printModal.classList.remove('active');
            printContentArea.innerHTML = ''; // Limpa o conteúdo ao fechar
        }

        // Nova função para preparar o conteúdo para impressão via iFrame
        function preparePrintContent(htmlContent, title) {
            const printWindow = window.open('', '_blank'); // Abre uma nova janela/aba
            printWindow.document.write(`
                <html>
                <head>
                    <title>${title}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
                    <style>
                        body {
                            font-family: 'Inter', sans-serif;
                            margin: 0;
                            padding: 20px;
                            color: #333;
                            -webkit-print-color-adjust: exact; /* Para imprimir cores de fundo e texto */
                        }
                        .patient-info, .form-print-section {
                            margin-bottom: 1.5rem;
                            border-bottom: 1px solid #ddd;
                            padding-bottom: 1rem;
                            page-break-inside: avoid;
                        }
                        .patient-info h3, .form-print-section h3 {
                            margin-top: 0;
                            color: #000;
                        }
                        .patient-info-grid {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 1rem;
                        }
                        .patient-info-item {
                            margin-bottom: 0.5rem;
                        }
                        .patient-info-label {
                            font-weight: 600;
                            display: inline-block;
                            min-width: 120px;
                        }
                        .form-question-print {
                            margin-bottom: 1rem;
                            border: 1px solid #eee;
                            padding: 0.75rem;
                            border-radius: 4px;
                            page-break-inside: avoid;
                        }
                        .form-question-print p {
                            margin: 0;
                        }
                        .form-question-print .question-text {
                            font-weight: 600;
                            color: #333;
                            margin-bottom: 0.5rem;
                        }
                        .form-question-print .answer-text {
                            margin-left: 1rem;
                            color: #555;
                        }
                        /* Esconder elementos de controle ou navegação, se necessário */
                        .no-print {
                            display: none !important;
                        }
                    </style>
                </head>
                <body>
                    ${htmlContent}
                </body>
                </html>
            `);
            printWindow.document.close(); // Fecha o documento para que o navegador comece a carregar o conteúdo
            printWindow.focus(); // Foca na nova janela (útil para alguns navegadores)

            // Usa setTimeout para garantir que o conteúdo seja renderizado antes da impressão
            printWindow.onload = function() {
                setTimeout(function() {
                    printWindow.print();
                    printWindow.close(); // Fecha a janela após a impressão (opcional)
                }, 200); // Pequeno atraso para renderização
            };
        }


        function generatePatientId() {
            const now = new Date();
            const datePart = now.getFullYear().toString() + (now.getMonth() + 1).toString().padStart(2, '0') + now.getDate().toString().padStart(2, '0');
            const randomPart = Math.floor(1000 + Math.random() * 9000);
            patientId.value = `PAC-${datePart}-${randomPart}`;
        }

        function calculateAge() {
            if (!birthDate.value) {
                age.value = '';
                return;
            }

            const birthDateObj = new Date(birthDate.value + 'T00:00:00'); // Garante que a data seja interpretada em UTC para evitar problemas de fuso horário
            const today = new Date();

            let ageInYears = today.getFullYear() - birthDateObj.getFullYear();
            const monthDiff = today.getMonth() - birthDateObj.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDateObj.getDate())) {
                ageInYears--;
            }

            age.value = ageInYears;
        }

        function addPhoneField() {
            const newPhoneRow = document.createElement('div'); // Cria um novo elemento div
            newPhoneRow.classList.add('phone-row'); // Adiciona a classe 'phone-row'
            newPhoneRow.innerHTML = `
                <select class="form-control form-select phone-type">
                    <option value="celular">Celular</option>
                    <option value="fixo">Fixo</option>
                    <option value="whatsapp">WhatsApp</option>
                    <option value="trabalho">Trabalho</option>
                </select>
                <input type="tel" class="form-control phone-number" placeholder="Número com DDD">
                <button type="button" class="btn btn-danger remove-phone-btn">Remover</button>
            `;

            const removeBtn = newPhoneRow.querySelector('.remove-phone-btn');
            removeBtn.addEventListener('click', async function() {
                const phoneRows = phonesContainer.querySelectorAll('.phone-row');
                if (phoneRows.length > 1) {
                    newPhoneRow.remove();
                } else {
                    await showAlert('É necessário pelo menos um telefone.');
                }
            });

            phonesContainer.insertBefore(newPhoneRow, addPhoneBtn);
        }

        function getPhoneData() {
            const phones = [];
            const phoneRows = phonesContainer.querySelectorAll('.phone-row');

            phoneRows.forEach(row => {
                const type = row.querySelector('.phone-type').value;
                const number = row.querySelector('.phone-number').value;

                if (number) {
                    phones.push({ type, number });
                }
            });

            return phones;
        }

        async function validateForm() {
            if (!fullName.value) {
                await showAlert('Por favor, preencha o nome completo do paciente.');
                return false;
            }

            if (!birthDate.value) {
                await showAlert('Por favor, informe a data de nascimento.');
                return false;
            }

            if (!gender.value) {
                await showAlert('Por favor, selecione o sexo do paciente.');
                return false;
            }

            const phones = getPhoneData();
            if (phones.length === 0) {
                await showAlert('Por favor, informe pelo menos um telefone.');
                return false;
            }

            return true;
        }

        async function savePatient() {
            if (!await validateForm()) return;

            const phones = getPhoneData();

            const patientData = {
                id: patientId.value,
                registrationDate: registrationDate.value,
                fullName: fullName.value,
                birthDate: birthDate.value,
                age: age.value,
                gender: gender.value,
                maritalStatus: maritalStatus.value,
                phones: phones,
                email: email.value,
                rg: rg.value,
                cpf: cpf.value,
                healthInsurance: healthInsurance.value,
                insuranceNumber: insuranceNumber.value,
                profession: profession.value,
                weight: weight.value,
                height: height.value,
                responsible: responsible.value,
                provenance: provenance.value,
                notes: notes.value,
                alerts: alerts.value,
                sessionPlan: { // Inicializa o plano de sessão
                    totalSessions: 0,
                    sessionsPerWeek: 0,
                    fixedTimes: [],
                    startDate: '',
                    scheduledAppointments: []
                }
            };

            if (isEditing && currentPatientId) {
                const index = patients.findIndex(p => p.id === currentPatientId);
                if (index !== -1) {
                    // Preserva o sessionPlan existente se estiver editando
                    patientData.sessionPlan = patients[index].sessionPlan || patientData.sessionPlan;
                    patients[index] = patientData;
                }
            } else {
                patients.push(patientData);
            }

            localStorage.setItem('patients', JSON.stringify(patients));
            renderPatientsList();
            closePatientModal(); // Fecha o modal primeiro
            await showAlert('Paciente salvo com sucesso!', 'Sucesso'); // Em seguida, exibe o alerta
        }

        function renderPatientsList(filteredPatients = null) {
            patientsList.innerHTML = '';

            const patientsToRender = filteredPatients || patients;

            if (patientsToRender.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="6" style="text-align: center;">${filteredPatients ? 'Nenhum paciente encontrado' : 'Nenhum paciente cadastrado'}</td>`;
                patientsList.appendChild(row);
                return;
            }

            patientsToRender.forEach(patient => {
                const row = document.createElement('tr');
                const mainPhone = patient.phones.length > 0 ? patient.phones[0].number : 'N/A';

                row.innerHTML = `
                    <td>${patient.id}</td>
                    <td>${patient.fullName}</td>
                    <td>${patient.age} anos</td>
                    <td>${patient.gender.charAt(0).toUpperCase() + patient.gender.slice(1)}</td>
                    <td>${mainPhone}</td>
                    <td class="action-buttons">
                        <button class="btn btn-outline btn-sm btn-view" data-id="${patient.id}">Ver</button>
                        <button class="btn btn-outline btn-sm btn-edit" data-id="${patient.id}">Editar</button>
                        <button class="btn btn-danger btn-sm btn-delete" data-id="${patient.id}">Excluir</button>
                        <button class="btn btn-outline btn-sm btn-view-records" data-id="${patient.id}" title="Ver Prontuário">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        </button>
                        <button class="btn btn-outline btn-sm btn-manage-sessions" data-id="${patient.id}" title="Gerenciar Sessões">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </button>
                    </td>
                `;

                patientsList.appendChild(row);
            });

            document.querySelectorAll('.btn-view').forEach(btn => {
                btn.addEventListener('click', function() {
                    viewPatient(this.getAttribute('data-id'));
                });
            });

            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    editPatient(this.getAttribute('data-id'));
                });
            });

            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', async function() {
                    await deletePatient(this.getAttribute('data-id'));
                });
            });

            document.querySelectorAll('.btn-view-records').forEach(btn => {
                btn.addEventListener('click', function() {
                    openRecordModal(this.getAttribute('data-id'));
                });
            });

            document.querySelectorAll('.btn-manage-sessions').forEach(btn => {
                btn.addEventListener('click', function() {
                    openSessionManagementModal(this.getAttribute('data-id'));
                });
            });
        }

        function viewPatient(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;

            let phonesHtml = '';
            patient.phones.forEach(phone => {
                phonesHtml += `<div class="patient-info-item">
                    <span class="patient-info-label">${phone.type.charAt(0).toUpperCase() + phone.type.slice(1)}:</span>
                    ${phone.number}
                </div>`;
            });

            const printHtml = `
                <div class="patient-info">
                    <h3>${patient.fullName}</h3>
                    <div class="patient-info-grid">
                        <div class="patient-info-item">
                            <span class="patient-info-label">ID:</span>
                            ${patient.id}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Data de Cadastro:</span>
                            ${formatDate(patient.registrationDate)}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Data de Nascimento:</span>
                            ${formatDate(patient.birthDate)} (${patient.age} anos)
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Sexo:</span>
                            ${patient.gender.charAt(0).toUpperCase() + patient.gender.slice(1)}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Estado Civil:</span>
                            ${patient.maritalStatus ? formatMaritalStatus(patient.maritalStatus) : 'Não informado'}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">RG:</span>
                            ${patient.rg || 'Não informado'}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">CPF:</span>
                            ${patient.cpf || 'Não informado'}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Convênio:</span>
                            ${patient.healthInsurance || 'Não informado'}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Nº Carteirinha:</span>
                            ${patient.insuranceNumber || 'Não informado'}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Profissão:</span>
                            ${patient.profession || 'Não informado'}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Peso:</span>
                            ${patient.weight ? patient.weight + ' kg' : 'Não informado'}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Altura:</span>
                            ${patient.height ? patient.height + ' cm' : 'Não informado'}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Responsável:</span>
                            ${patient.responsible || 'Não informado'}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Procedência:</span>
                            ${patient.provenance || 'Não informado'}
                        </div>
                    </div>
                </div>

                <div class="patient-info">
                    <h3>Contatos</h3>
                    ${phonesHtml}
                    <div class="patient-info-item">
                        <span class="patient-info-label">E-mail:</span>
                        ${patient.email || 'Não informado'}
                    </div>
                </div>

                ${patient.notes ? `
                <div class="patient-info">
                    <h3>Observações</h3>
                    <p>${patient.notes}</p>
                </div>
                ` : ''}

                ${patient.alerts ? `
                <div class="patient-info">
                    <h3>Avisos Importantes</h3>
                    <p style="color: var(--red-500);">${patient.alerts}</p>
                </div>
                ` : ''}
            `;
            preparePrintContent(printHtml, "Dados do Paciente"); // Chama a nova função de impressão
        }

        async function editPatient(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) {
                await showAlert('Paciente não encontrado.');
                return;
            }

            isEditing = true;
            currentPatientId = patientId;

            patientId.value = patient.id;
            registrationDate.value = patient.registrationDate;
            fullName.value = patient.fullName;
            birthDate.value = patient.birthDate;
            age.value = patient.age;
            gender.value = patient.gender;
            maritalStatus.value = patient.maritalStatus || '';
            email.value = patient.email || '';
            rg.value = patient.rg || '';
            cpf.value = patient.cpf || '';
            healthInsurance.value = patient.healthInsurance || '';
            insuranceNumber.value = patient.insuranceNumber || '';
            profession.value = patient.profession || '';
            weight.value = patient.weight || '';
            height.value = patient.height || '';
            responsible.value = patient.responsible || '';
            provenance.value = patient.provenance || '';
            notes.value = patient.notes || '';
            alerts.value = patient.alerts || '';

            const phoneRows = phonesContainer.querySelectorAll('.phone-row');
            phoneRows.forEach(row => row.remove());

            if (patient.phones.length > 0) {
                patient.phones.forEach(phone => {
                    const newPhoneRow = document.createElement('div');
                    newPhoneRow.classList.add('phone-row');
                    newPhoneRow.innerHTML = `
                        <select class="form-control form-select phone-type">
                            <option value="celular">Celular</option>
                            <option value="fixo">Fixo</option>
                            <option value="whatsapp">WhatsApp</option>
                            <option value="trabalho">Trabalho</option>
                        </select>
                        <input type="tel" class="form-control phone-number" placeholder="Número com DDD">
                        <button type="button" class="btn btn-danger remove-phone-btn">Remover</button>
                    `;

                    const typeSelect = newPhoneRow.querySelector('.phone-type');
                    const numberInput = newPhoneRow.querySelector('.phone-number');

                    typeSelect.value = phone.type;
                    numberInput.value = phone.number;

                    const removeBtn = newPhoneRow.querySelector('.remove-phone-btn');
                    removeBtn.addEventListener('click', async function() {
                        const currentPhoneRows = phonesContainer.querySelectorAll('.phone-row');
                        if (currentPhoneRows.length > 1) {
                            newPhoneRow.remove();
                        } else {
                            await showAlert('É necessário pelo menos um telefone.');
                        }
                    });

                    phonesContainer.insertBefore(newPhoneRow, addPhoneBtn);
                });
            } else {
                addPhoneField();
            }

            openPatientModal(null); // Abre o modal no modo de edição
        }

        async function deletePatient(patientIdToDelete) {
            const confirmed = await showConfirm('Tem certeza que deseja excluir este paciente?');
            if (confirmed) {
                patients = patients.filter(p => p.id !== patientIdToDelete);
                localStorage.setItem('patients', JSON.stringify(patients));
                renderPatientsList();
                await showAlert('Paciente excluído com sucesso!', 'Sucesso'); // Exibe alerta de sucesso
            }
        }

        async function preparePrint() {
            if (!await validateForm()) return;

            const tempPatient = {
                fullName: fullName.value,
                id: patientId.value,
                registrationDate: registrationDate.value,
                birthDate: birthDate.value,
                age: age.value,
                gender: gender.value,
                maritalStatus: maritalStatus.value,
                phones: getPhoneData(),
                email: email.value,
                rg: rg.value,
                cpf: cpf.value,
                healthInsurance: healthInsurance.value,
                insuranceNumber: insuranceNumber.value,
                profession: profession.value,
                weight: weight.value,
                height: height.value,
                responsible: responsible.value,
                provenance: provenance.value,
                notes: notes.value,
                alerts: alerts.value
            };

            let phonesHtml = '';
            tempPatient.phones.forEach(phone => {
                phonesHtml += `<div class="patient-info-item">
                    <span class="patient-info-label">${phone.type.charAt(0).toUpperCase() + phone.type.slice(1)}:</span>
                    ${phone.number}
                </div>`;
            });

            const printHtml = `
                <div class="patient-info">
                    <h3>${tempPatient.fullName}</h3>
                    <div class="patient-info-grid">
                        <div class="patient-info-item">
                            <span class="patient-info-label">ID:</span>
                            ${tempPatient.id}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Data de Cadastro:</span>
                            ${formatDate(tempPatient.registrationDate)}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Data de Nascimento:</span>
                            ${formatDate(tempPatient.birthDate)} (${tempPatient.age} anos)
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Sexo:</span>
                            ${tempPatient.gender.charAt(0).toUpperCase() + tempPatient.gender.slice(1)}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Estado Civil:</span>
                            ${tempPatient.maritalStatus ? formatMaritalStatus(tempPatient.maritalStatus) : 'Não informado'}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">RG:</span>
                            ${tempPatient.rg || 'Não informado'}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">CPF:</span>
                            ${tempPatient.cpf || 'Não informado'}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Convênio:</span>
                            ${tempPatient.healthInsurance || 'Não informado'}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Nº Carteirinha:</span>
                            ${tempPatient.insuranceNumber || 'Não informado'}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Profissão:</span>
                            ${tempPatient.profession || 'Não informado'}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Peso:</span>
                            ${tempPatient.weight ? tempPatient.weight + ' kg' : 'Não informado'}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Altura:</span>
                            ${tempPatient.height ? tempPatient.height + ' cm' : 'Não informado'}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Responsável:</span>
                            ${tempPatient.responsible || 'Não informado'}
                        </div>
                        <div class="patient-info-item">
                            <span class="patient-info-label">Procedência:</span>
                            ${tempPatient.provenance || 'Não informado'}
                        </div>
                    </div>
                </div>

                <div class="patient-info">
                    <h3>Contatos</h3>
                    ${phonesHtml}
                    <div class="patient-info-item">
                        <span class="patient-info-label">E-mail:</span>
                        ${tempPatient.email || 'Não informado'}
                    </div>
                </div>

                ${tempPatient.notes ? `
                <div class="patient-info">
                    <h3>Observações</h3>
                    <p>${tempPatient.notes}</p>
                </div>
                ` : ''}

                ${tempPatient.alerts ? `
                <div class="patient-info">
                    <h3>Avisos Importantes</h3>
                    <p style="color: var(--red-500);">${tempPatient.alerts}</p>
                </div>
                ` : ''}
            `;
            preparePrintContent(printHtml, "Dados do Paciente"); // Chama a nova função de impressão
        }

        function searchPatients() {
            const searchTerm = searchInput.value.toLowerCase();
            const filterType = searchFilter.value;

            if (!searchTerm) {
                renderPatientsList();
                return;
            }

            const filteredPatients = patients.filter(patient => {
                if (filterType === 'all') {
                    return (
                        patient.id.toLowerCase().includes(searchTerm) ||
                        patient.fullName.toLowerCase().includes(searchTerm) ||
                        (patient.cpf && patient.cpf.toLowerCase().includes(searchTerm)) ||
                        (patient.rg && patient.rg.toLowerCase().includes(searchTerm)) ||
                        (patient.healthInsurance && patient.healthInsurance.toLowerCase().includes(searchTerm)) ||
                        patient.phones.some(phone => phone.number.includes(searchTerm))
                    );
                }

                switch (filterType) {
                    case 'id':
                        return patient.id.toLowerCase().includes(searchTerm);
                    case 'name':
                        return patient.fullName.toLowerCase().includes(searchTerm);
                    case 'phone':
                        return patient.phones.some(phone => phone.number.includes(searchTerm));
                    case 'healthInsurance':
                        return patient.healthInsurance && patient.healthInsurance.toLowerCase().includes(searchTerm);
                    case 'cpf':
                        return patient.cpf && patient.cpf.toLowerCase().includes(searchTerm);
                    default:
                        return true;
                }
            });

            renderPatientsList(filteredPatients);
        }

        function clearSearch() {
            searchInput.value = '';
            searchFilter.value = 'all';
            renderPatientsList();
        }

        async function exportBackup() {
            if (patients.length === 0) {
                await showAlert('Não há pacientes cadastrados para exportar.');
                return;
            }

            const dataStr = JSON.stringify(patients, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            const exportName = `backup-pacientes-${new Date().toISOString().slice(0, 10)}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportName);
            linkElement.click();
            await showAlert('Backup de pacientes exportado com sucesso!', 'Sucesso'); // Exibe alerta de sucesso
        }

        function triggerImportBackup() {
            backupFileInput.click();
        }

        async function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                await showAlert('Por favor, selecione um arquivo JSON válido.');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedPatients = JSON.parse(e.target.result);

                    if (!Array.isArray(importedPatients)) {
                        throw new Error('O arquivo não contém uma lista válida de pacientes.');
                    }

                    const confirmed = await showConfirm(`Deseja importar ${importedPatients.length} paciente(s)? Isso substituirá seus dados atuais.`);
                    if (confirmed) {
                        patients = importedPatients;
                        localStorage.setItem('patients', JSON.stringify(patients));
                        renderPatientsList();
                        await showAlert('Backup importado com sucesso!', 'Sucesso');
                    }
                } catch (error) {
                    await showAlert('Erro ao importar backup: ' + error.message, 'Erro');
                    console.error(error);
                }
            };
            reader.readAsText(file);

            event.target.value = '';
        }

        function formatDate(dateString) {
            if (!dateString) return 'Não informado';

            const date = new Date(dateString + 'T00:00:00'); // Adiciona T00:00:00 para garantir que seja interpretado como início do dia UTC
            return date.toLocaleDateString('pt-BR');
        }

        function formatMaritalStatus(status) {
            const statusMap = {
                'solteiro': 'Solteiro(a)',
                'casado': 'Casado(a)',
                'divorciado': 'Divorciado(a)',
                'viuvo': 'Viúvo(a)',
                'separado': 'Separado(a)',
                'uniao_estavel': 'União Estável'
            };

            return statusMap[status] || status;
        }

        // --- Funções de Gerenciamento de Formulários ---

        function generateFormId() {
            return `FORM-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
        }
        
        // Função para gerar um ID único para a pergunta
        function generateQuestionId() {
            return `Q-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
        }


        function renderFormsList(filtered = null) {
            formsList.innerHTML = '';
            const formsToRender = filtered || forms;

            if (formsToRender.length === 0) {
                formsList.innerHTML = `<div class="p-4 text-gray-500">${filtered ? 'Nenhum formulário encontrado.' : 'Nenhum formulário cadastrado. Clique em "Novo Formulário" para começar.'}</div>`;
                return;
            }

            formsToRender.forEach(form => {
                const formDiv = document.createElement('div');
                formDiv.classList.add('p-3', 'bg-white', 'rounded-md', 'shadow-sm', 'flex', 'justify-between', 'items-center');
                formDiv.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-gray-800">${form.fileName || 'Formulário sem título'}</h3>
                        <p class="text-sm text-gray-600">${form.mainTitle || 'Sem título principal'}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button class="btn btn-outline btn-sm edit-form-btn" data-id="${form.id}">Editar</button>
                        <button class="btn btn-danger btn-sm delete-form-btn" data-id="${form.id}">Excluir</button>
                    </div>
                `;
                formsList.appendChild(formDiv);
            });

            document.querySelectorAll('.edit-form-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    openFormEditor(this.dataset.id);
                });
            });

            document.querySelectorAll('.delete-form-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    await deleteForm(this.dataset.id);
                });
            });
        }

        createNewFormBtn.addEventListener('click', () => openFormEditor(null));
        saveFormDefinitionBtn.addEventListener('click', saveFormDefinition);
        previewFormBtn.addEventListener('click', previewForm);
        closeFormEditorBtn.addEventListener('click', closeFormEditor);
        addQuestionBtn.addEventListener('click', () => addQuestion()); // Chama addQuestion sem argumentos para gerar novo ID

        formSearchBtn.addEventListener('click', searchForms);
        formClearSearchBtn.addEventListener('click', clearFormSearch);
        formSearchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                searchForms();
            }
        });

        exportFormsBackupBtn.addEventListener('click', exportFormsBackup);
        importFormsBackupBtn.addEventListener('click', triggerImportFormsBackup);
        formsBackupFileInput.addEventListener('change', importFormsBackup);


        function openFormEditor(formId) {
            agendaView.classList.add('hidden');
            patientListView.classList.add('hidden');
            formsView.classList.add('hidden');
            therapyView.classList.add('hidden'); // Esconde a view de terapia
            formEditorView.classList.remove('hidden');

            questionsContainer.innerHTML = ''; // Limpa as perguntas anteriores

            if (formId) {
                currentEditingForm = forms.find(f => f.id === formId);
                if (currentEditingForm) {
                    formEditorTitle.textContent = currentEditingForm.fileName || 'Editar Formulário';
                    formFileName.value = currentEditingForm.fileName || '';
                    formMainTitle.value = currentEditingForm.mainTitle || '';
                    formDescription.value = currentEditingForm.description || '';
                    // Garante que todas as perguntas tenham um ID único ao carregar para edição
                    currentEditingForm.questions.forEach(q => {
                        if (!q.id || q.id === 'undefined') { // Verifica se o ID é indefinido ou a string "undefined"
                            q.id = generateQuestionId(); // Gera um novo ID se necessário
                        }
                        renderQuestionInEditor(q);
                    });
                } else {
                    showAlert('Formulário não encontrado para edição.', 'Erro');
                    closeFormEditor();
                }
            } else {
                // Novo formulário
                formEditorTitle.textContent = 'Novo Formulário';
                formFileName.value = '';
                formMainTitle.value = '';
                formDescription.value = '';
                currentEditingForm = {
                    id: generateFormId(),
                    fileName: '',
                    mainTitle: '',
                    description: '',
                    questions: []
                };
                addQuestion(); // Adiciona uma primeira pergunta em branco
            }
        }

        function closeFormEditor() {
            formEditorView.classList.add('hidden');
            formsView.classList.remove('hidden');
            currentEditingForm = null;
            renderFormsList(); // Atualiza a lista de formulários
        }

        async function saveFormDefinition() {
            if (!formFileName.value.trim()) {
                await showAlert('Por favor, dê um nome ao arquivo do formulário.');
                return;
            }
            if (!formMainTitle.value.trim()) {
                await showAlert('Por favor, insira um título principal para o formulário.');
                return;
            }

            currentEditingForm.fileName = formFileName.value.trim();
            currentEditingForm.mainTitle = formMainTitle.value.trim();
            currentEditingForm.description = formDescription.value.trim();
            currentEditingForm.questions = [];

            // Coleta todas as perguntas do editor
            questionsContainer.querySelectorAll('.form-editor-question').forEach(qDiv => {
                const question = {
                    id: qDiv.dataset.questionId, // Usa o ID existente ou o recém-gerado
                    text: qDiv.querySelector('.question-text').value.trim(),
                    type: qDiv.querySelector('.question-type').value,
                    required: qDiv.querySelector('.question-required').checked,
                    options: []
                };

                if (['multiple_choice', 'checkboxes', 'dropdown'].includes(question.type)) {
                    qDiv.querySelectorAll('.option-input').forEach(optionInput => {
                        if (optionInput.value.trim()) {
                            question.options.push(optionInput.value.trim());
                        }
                    });
                } else if (question.type === 'linear_scale') {
                    // Para escala linear, as opções são os valores min, max e rótulos
                    const inputs = qDiv.querySelectorAll('.form-control[type="number"], .form-control[type="text"]');
                    question.options.push(inputs[0].value); // min
                    question.options.push(inputs[1].value); // max
                    question.options.push(inputs[2].value); // label 1
                    question.options.push(inputs[3].value); // label max
                }
                currentEditingForm.questions.push(question);
            });

            // Validação de perguntas (ex: garantir que perguntas de múltipla escolha tenham opções)
            for (const q of currentEditingForm.questions) {
                if (['multiple_choice', 'checkboxes', 'dropdown'].includes(q.type) && q.options.length === 0) {
                    await showAlert(`A pergunta "${q.text || 'Sem título'}" do tipo "${q.type}" precisa de pelo menos uma opção.`);
                    return;
                }
            }


            const existingIndex = forms.findIndex(f => f.id === currentEditingForm.id);
            if (existingIndex !== -1) {
                forms[existingIndex] = currentEditingForm;
            } else {
                forms.push(currentEditingForm);
            }

            localStorage.setItem('forms', JSON.stringify(forms));
            await showAlert('Formulário salvo com sucesso!', 'Sucesso'); // Exibe alerta de sucesso
            closeFormEditor(); // Fecha o editor após o alerta
        }

        async function deleteForm(formIdToDelete) {
            const confirmed = await showConfirm('Tem certeza que deseja excluir este formulário? Esta ação é irreversível.');
            if (confirmed) {
                forms = forms.filter(f => f.id !== formIdToDelete);
                localStorage.setItem('forms', JSON.stringify(forms));
                renderFormsList();
                await showAlert('Formulário excluído com sucesso!', 'Sucesso'); // Exibe alerta de sucesso
            }
        }

        function searchForms() {
            const searchTerm = formSearchInput.value.toLowerCase();
            if (!searchTerm) {
                renderFormsList();
                return;
            }
            const filteredForms = forms.filter(form =>
                form.fileName.toLowerCase().includes(searchTerm) ||
                form.mainTitle.toLowerCase().includes(searchTerm) ||
                form.description.toLowerCase().includes(searchTerm)
            );
            renderFormsList(filteredForms);
        }

        function clearFormSearch() {
            formSearchInput.value = '';
            renderFormsList();
        }

        async function exportFormsBackup() {
            if (forms.length === 0) {
                await showAlert('Não há formulários cadastrados para exportar.');
                return;
            }

            const dataStr = JSON.stringify(forms, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            const exportName = `backup-formularios-${new Date().toISOString().slice(0, 10)}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportName);
            linkElement.click();
            await showAlert('Backup de formulários exportado com sucesso!', 'Sucesso'); // Exibe alerta de sucesso
        }

        function triggerImportFormsBackup() {
            formsBackupFileInput.click();
        }

        async function importFormsBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                await showAlert('Por favor, selecione um arquivo JSON válido.');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedForms = JSON.parse(e.target.result);

                    if (!Array.isArray(importedForms)) {
                        throw new Error('O arquivo não contém uma lista válida de formulários.');
                    }

                    // Corrige IDs "undefined" em formulários importados
                    importedForms.forEach(form => {
                        form.id = form.id === 'undefined' ? generateFormId() : form.id;
                        form.questions.forEach(q => {
                            if (!q.id || q.id === 'undefined') {
                                q.id = generateQuestionId();
                            }
                        });
                    });

                    const confirmed = await showConfirm(`Deseja importar ${importedForms.length} formulário(s)? Isso substituirá seus dados atuais.`, 'Confirmação');
                    if (confirmed) {
                        forms = importedForms;
                        localStorage.setItem('forms', JSON.stringify(forms));
                        renderFormsList();
                        await showAlert('Backup de formulários importado com sucesso!', 'Sucesso');
                    }
                } catch (error) {
                    await showAlert('Erro ao importar backup de formulários: ' + error.message, 'Erro');
                    console.error(error);
                }
            };
            reader.readAsText(file);

            event.target.value = '';
        }


        function addQuestion(questionData = null) {
            const questionId = questionData && questionData.id && questionData.id !== 'undefined' ? questionData.id : generateQuestionId();
            const questionDiv = document.createElement('div');
            questionDiv.classList.add('form-editor-question');
            questionDiv.dataset.questionId = questionId;

            questionDiv.innerHTML = `
                <div class="form-editor-question-actions">
                    <button type="button" class="btn btn-outline btn-sm duplicate-question-btn" title="Duplicar Pergunta">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h6a2 2 0 012 2v10a2 2 0 01-2 2h-6a2 2 0 01-2-2v-2m0-4h.01"></path></svg>
                    </button>
                    <button type="button" class="btn btn-danger btn-sm delete-question-btn" title="Excluir Pergunta">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
                <div class="form-group">
                    <input type="text" class="form-control question-text" placeholder="Pergunta sem título" value="${questionData ? questionData.text : ''}">
                </div>
                <div class="form-group">
                    <select class="form-control form-select question-type">
                        <option value="short_answer">Resposta curta</option>
                        <option value="paragraph">Parágrafo</option>
                        <option value="multiple_choice">Múltipla escolha</option>
                        <option value="checkboxes">Caixas de seleção</option>
                        <option value="dropdown">Lista suspensa</option>
                        <option value="linear_scale">Escala linear (1-5)</option>
                        <option value="date">Data</option>
                        <option value="time">Hora</option>
                    </select>
                </div>
                <div class="form-editor-options-container">
                    </div>
                <div class="flex items-center justify-end mt-2">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-600 question-required" ${questionData && questionData.required ? 'checked' : ''}>
                        <span class="ml-2 text-sm text-gray-700">Obrigatória</span>
                    </label>
                </div>
            `;

            questionsContainer.appendChild(questionDiv);

            const questionTypeSelect = questionDiv.querySelector('.question-type');
            const optionsContainer = questionDiv.querySelector('.form-editor-options-container');

            // Define o tipo de pergunta se estiver editando
            if (questionData) {
                questionTypeSelect.value = questionData.type;
                if (['multiple_choice', 'checkboxes', 'dropdown'].includes(questionData.type)) {
                    renderOptionsForQuestion(optionsContainer, questionData.options);
                } else if (questionData.type === 'linear_scale') {
                    renderOptionsForQuestion(optionsContainer, questionData.options);
                }
            }

            questionTypeSelect.addEventListener('change', (event) => {
                renderOptionsForQuestion(optionsContainer, []); // Limpa e renderiza novas opções
            });

            questionDiv.querySelector('.delete-question-btn').addEventListener('click', async function() {
                const confirmed = await showConfirm('Tem certeza que deseja excluir esta pergunta?');
                if (confirmed) {
                    questionDiv.remove();
                }
            });

            questionDiv.querySelector('.duplicate-question-btn').addEventListener('click', function() {
                const duplicatedQuestionData = {
                    id: generateQuestionId(), // Gera um novo ID para a cópia
                    text: questionDiv.querySelector('.question-text').value + ' (Cópia)',
                    type: questionDiv.querySelector('.question-type').value,
                    required: questionDiv.querySelector('.question-required').checked,
                    options: []
                };
                if (['multiple_choice', 'checkboxes', 'dropdown'].includes(duplicatedQuestionData.type)) {
                    questionDiv.querySelectorAll('.option-input').forEach(optionInput => {
                        if (optionInput.value.trim()) {
                            duplicatedQuestionData.options.push(optionInput.value.trim());
                        }
                    });
                } else if (duplicatedQuestionData.type === 'linear_scale') {
                    const inputs = questionDiv.querySelectorAll('.form-control[type="number"], .form-control[type="text"]');
                    duplicatedQuestionData.options.push(inputs[0].value); // min
                    duplicatedQuestionData.options.push(inputs[1].value); // max
                    duplicatedQuestionData.options.push(inputs[2].value); // label 1
                    duplicatedQuestionData.options.push(inputs[3].value); // label max
                }
                addQuestion(duplicatedQuestionData);
            });
        }

        function renderOptionsForQuestion(optionsContainer, existingOptions = []) {
            optionsContainer.innerHTML = '';
            const questionType = optionsContainer.parentElement.querySelector('.question-type').value;

            if (['multiple_choice', 'checkboxes', 'dropdown'].includes(questionType)) {
                existingOptions.forEach(optionText => {
                    addOptionField(optionsContainer, optionText);
                });
                addOptionField(optionsContainer, ''); // Adiciona um campo vazio para nova opção
                const addOptionButton = document.createElement('button');
                addOptionButton.type = 'button';
                addOptionButton.classList.add('btn', 'btn-outline', 'btn-sm', 'form-editor-add-option-btn', 'mt-2');
                addOptionButton.textContent = '+ Adicionar Opção';
                addOptionButton.addEventListener('click', () => addOptionField(optionsContainer, ''));
                optionsContainer.appendChild(addOptionButton);
            } else if (questionType === 'linear_scale') {
                optionsContainer.innerHTML = `
                    <div class="flex items-center gap-2">
                        <label class="text-sm">De:</label>
                        <input type="number" class="form-control w-16" value="${existingOptions[0] || 1}" min="0" max="10">
                        <label class="text-sm">Para:</label>
                        <input type="number" class="form-control w-16" value="${existingOptions[1] || 5}" min="1" max="10">
                    </div>
                    <div class="flex items-center gap-2 mt-2">
                        <label class="text-sm">Rótulo 1:</label>
                        <input type="text" class="form-control flex-grow" placeholder="Ex: Muito Ruim" value="${existingOptions[2] || ''}">
                    </div>
                    <div class="flex items-center gap-2 mt-2">
                        <label class="text-sm">Rótulo ${existingOptions[1] || 5}:</label>
                        <input type="text" class="form-control flex-grow" placeholder="Ex: Excelente" value="${existingOptions[3] || ''}">
                    </div>
                `;
            }
            // Para outros tipos, o container de opções permanece vazio
        }

        function addOptionField(optionsContainer, value = '') {
            const optionDiv = document.createElement('div');
            optionDiv.innerHTML = `
                <input type="text" class="form-control option-input" placeholder="Opção" value="${value}">
                <button type="button" class="btn btn-danger btn-sm remove-option-btn">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            `;
            optionsContainer.insertBefore(optionDiv, optionsContainer.querySelector('.form-editor-add-option-btn'));
            optionDiv.querySelector('.remove-option-btn').addEventListener('click', () => optionDiv.remove());
        }

        function renderQuestionInEditor(questionData) {
            addQuestion(questionData);
        }

        // --- Funções de Preview de Formulário ---
        function previewForm() {
            if (!currentEditingForm) {
                showAlert('Nenhum formulário aberto para pré-visualizar.', 'Aviso');
                return;
            }

            previewOnlyFormModalTitle.textContent = currentEditingForm.fileName || 'Visualização';
            previewOnlyFormMainTitle.textContent = currentEditingForm.mainTitle || '';
            previewOnlyFormDescription.textContent = currentEditingForm.description || '';
            previewOnlyFormContentArea.innerHTML = ''; // Limpa conteúdo anterior

            if (currentEditingForm.questions.length === 0) {
                previewOnlyFormContentArea.innerHTML = '<p class="text-gray-500">Este formulário não possui perguntas.</p>';
            } else {
                currentEditingForm.questions.forEach(question => {
                    const questionDiv = document.createElement('div');
                    questionDiv.classList.add('mb-4', 'p-3', 'border', 'border-gray-200', 'rounded-md');

                    let inputHtml = '';
                    switch (question.type) {
                        case 'short_answer':
                            inputHtml = `<input type="text" class="form-control" placeholder="Sua resposta..." disabled>`;
                            break;
                        case 'paragraph':
                            inputHtml = `<textarea class="form-control textarea-field" placeholder="Sua resposta longa..." disabled></textarea>`;
                            break;
                        case 'multiple_choice':
                            inputHtml = question.options.map(option => `
                                <div>
                                    <input type="radio" name="preview_q_${question.id}" value="${option}" class="mr-2" disabled>
                                    <label>${option}</label>
                                </div>
                            `).join('');
                            break;
                        case 'checkboxes':
                            inputHtml = question.options.map(option => `
                                <div>
                                    <input type="checkbox" name="preview_q_${question.id}" value="${option}" class="mr-2" disabled>
                                    <label>${option}</label>
                                </div>
                            `).join('');
                            break;
                        case 'dropdown':
                            inputHtml = `
                                <select class="form-control form-select" disabled>
                                    <option value="">Selecione uma opção</option>
                                    ${question.options.map(option => `<option value="${option}">${option}</option>`).join('')}
                                </select>
                            `;
                            break;
                        case 'linear_scale':
                            inputHtml = `
                                <div class="flex items-center gap-2">
                                    <span>${question.options[2] || question.options[0] || '1'}</span>
                                    <input type="range" min="${question.options[0] || 1}" max="${question.options[1] || 5}" value="${question.options[0] || 1}" class="flex-grow" disabled>
                                    <span>${question.options[3] || question.options[1] || '5'}</span>
                                </div>
                            `;
                            break;
                        case 'date':
                            inputHtml = `<input type="date" class="form-control" disabled>`;
                            break;
                        case 'time':
                            inputHtml = `<input type="time" class="form-control" disabled>`;
                            break;
                    }

                    questionDiv.innerHTML = `
                        <p class="font-medium text-gray-700 mb-2">${question.text} ${question.required ? '<span class="text-red-500">*</span>' : ''}</p>
                        ${inputHtml}
                    `;
                    previewOnlyFormContentArea.appendChild(questionDiv);
                });
            }

            previewOnlyFormModal.classList.add('active');
        }

        closePreviewOnlyFormModalBtn.addEventListener('click', () => previewOnlyFormModal.classList.remove('active'));
        closePreviewOnlyBtn.addEventListener('click', () => previewOnlyFormModal.classList.remove('active'));
        previewOnlyFormModal.addEventListener('click', (e) => {
            if (e.target === previewOnlyFormModal) {
                previewOnlyFormModal.classList.remove('active');
            }
        });


        // --- Funções de Aplicação de Formulários no Prontuário ---

        function openApplyFormModal(patientId, recordType) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) {
                showAlert('Paciente não encontrado.', 'Erro');
                return;
            }
            currentPatientId = patientId; // Garante que o paciente atual está definido
            currentPatientNameForForms.textContent = patient.fullName;
            // Corrigido para Prontuário quando o recordType é 'anamnese'
            applyFormModalTitle.textContent = `Formulários de ${patient.fullName} (${recordType === 'anamnese' ? 'Prontuário' : 'Avaliação'})`;

            // Ativa a aba correta por padrão
            // Se o recordType for 'anamnese', ele deve abrir a aba de aplicação de formulário
            // Se o recordType for 'avaliacao', ele deve abrir a aba de formulários aplicados
            if (recordType === 'anamnese') {
                tabApplyForm.classList.add('border-blue-500', 'text-blue-600');
                tabAppliedForms.classList.remove('border-blue-500', 'text-blue-600');
                applyFormContent.classList.remove('hidden');
                appliedFormsContent.classList.add('hidden');
                renderAvailableForms(); // Renderiza formulários para aplicar
            } else if (recordType === 'avaliacao') {
                tabAppliedForms.classList.add('border-blue-500', 'text-blue-600');
                tabApplyForm.classList.remove('border-blue-500', 'text-blue-600');
                appliedFormsContent.classList.remove('hidden');
                applyFormContent.classList.add('hidden');
                renderPatientAppliedForms(patientId); // Renderiza formulários já aplicados
            }


            applyFormModal.classList.add('active');
            closeRecordModal(); // Fecha o modal de prontuário
        }

        closeApplyFormModalBtn.addEventListener('click', () => applyFormModal.classList.remove('active'));
        applyFormModal.addEventListener('click', (e) => {
            if (e.target === applyFormModal) {
                applyFormModal.classList.remove('active');
            }
        });

        tabApplyForm.addEventListener('click', () => {
            tabApplyForm.classList.add('border-blue-500', 'text-blue-600');
            tabAppliedForms.classList.remove('border-blue-500', 'text-blue-600');
            applyFormContent.classList.remove('hidden');
            appliedFormsContent.classList.add('hidden');
            renderAvailableForms();
        });

        tabAppliedForms.addEventListener('click', () => {
            tabAppliedForms.classList.add('border-blue-500', 'text-blue-600');
            tabApplyForm.classList.remove('border-blue-500', 'text-blue-600');
            appliedFormsContent.classList.remove('hidden');
            applyFormContent.classList.add('hidden');
            renderPatientAppliedForms(currentPatientId);
        });

        formSearchInputForApply.addEventListener('keyup', () => renderAvailableForms(formSearchInputForApply.value));


        function renderAvailableForms(searchTerm = '') {
            availableFormsList.innerHTML = '';
            const lowerCaseSearchTerm = searchTerm.toLowerCase();

            const filtered = forms.filter(form =>
                form.fileName.toLowerCase().includes(lowerCaseSearchTerm) ||
                form.mainTitle.toLowerCase().includes(lowerCaseSearchTerm) ||
                form.description.toLowerCase().includes(searchTerm)
            );

            if (filtered.length === 0) {
                availableFormsList.innerHTML = `<div class="p-4 text-gray-500">Nenhum formulário disponível.</div>`;
                return;
            }

            filtered.forEach(form => {
                const formDiv = document.createElement('div');
                formDiv.classList.add('p-3', 'border-b', 'border-gray-200', 'cursor-pointer', 'hover:bg-gray-100', 'flex', 'justify-between', 'items-center');
                formDiv.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-gray-800">${form.fileName}</h3>
                        <p class="text-sm text-gray-600">${form.mainTitle}</p>
                    </div>
                    <button class="btn btn-primary btn-sm apply-form-btn" data-form-id="${form.id}">Aplicar</button>
                `;
                availableFormsList.appendChild(formDiv);
            });

            document.querySelectorAll('.apply-form-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const formId = this.dataset.formId;
                    const selectedForm = forms.find(f => f.id === formId);
                    if (selectedForm) {
                        openFillFormModal(selectedForm, currentPatientId, null); // Abre para preencher um novo formulário
                    }
                });
            });
        }

        function renderPatientAppliedForms(patientId) {
            patientAppliedFormsList.innerHTML = '';
            const patientForms = appliedForms.filter(af => af.patientId === patientId);

            if (patientForms.length === 0) {
                patientAppliedFormsList.innerHTML = `<div class="p-4 text-gray-500">Nenhum formulário aplicado a este paciente.</div>`;
                return;
            }

            patientForms.forEach(appliedForm => {
                const formDiv = document.createElement('div');
                formDiv.classList.add('p-3', 'border-b', 'border-gray-200', 'flex', 'justify-between', 'items-center', 'space-x-2');
                formDiv.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-gray-800">${appliedForm.formMainTitle}</h3>
                        <p class="text-sm text-gray-600">Aplicado em: ${formatDate(appliedForm.appliedDate)}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button class="btn btn-outline btn-sm view-applied-form-btn" data-applied-form-id="${appliedForm.id}">Ver</button>
                        <button class="btn btn-outline btn-sm edit-applied-form-btn" data-applied-form-id="${appliedForm.id}">Editar</button>
                        <button class="btn btn-danger btn-sm delete-applied-form-btn" data-applied-form-id="${appliedForm.id}">Excluir</button>
                        <button class="btn btn-info btn-sm print-applied-form-btn" data-applied-form-id="${appliedForm.id}">Imprimir</button>
                    </div>
                `;
                patientAppliedFormsList.appendChild(formDiv);
            });

            document.querySelectorAll('.view-applied-form-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const appliedFormId = this.dataset.appliedFormId;
                    const instance = appliedForms.find(af => af.id === appliedFormId);
                    if (instance) {
                        // Passa a definição do formulário para o modal de preenchimento/visualização
                        const formDef = forms.find(f => f.id === instance.formId);
                        if (formDef) {
                            openFillFormModal(formDef, instance.patientId, instance, true); // Visualizar
                        } else {
                            showAlert('Definição do formulário original não encontrada.', 'Erro');
                        }
                    }
                });
            });

            document.querySelectorAll('.edit-applied-form-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const appliedFormId = this.dataset.appliedFormId;
                    const instance = appliedForms.find(af => af.id === appliedFormId);
                    if (instance) {
                        // Passa a definição do formulário para o modal de preenchimento/visualização
                        const formDef = forms.find(f => f.id === instance.formId);
                        if (formDef) {
                            openFillFormModal(formDef, instance.patientId, instance, false); // Editar
                        } else {
                            showAlert('Definição do formulário original não encontrada.', 'Erro');
                        }
                    }
                });
            });

            document.querySelectorAll('.delete-applied-form-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const appliedFormId = this.dataset.appliedFormId;
                    const confirmed = await showConfirm('Tem certeza que deseja excluir este formulário preenchido?');
                    if (confirmed) {
                        appliedForms = appliedForms.filter(af => af.id !== appliedFormId);
                        localStorage.setItem('appliedForms', JSON.stringify(appliedForms));
                        renderPatientAppliedForms(currentPatientId);
                        await showAlert('Formulário preenchido excluído com sucesso!', 'Sucesso'); // Exibe alerta de sucesso
                    }
                });
            });

            document.querySelectorAll('.print-applied-form-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const appliedFormId = this.dataset.appliedFormId;
                    const instance = appliedForms.find(af => af.id === appliedFormId);
                    if (instance) {
                        preparePrintFilledForm(instance);
                    }
                });
            });
        }

        // --- Funções para Preencher/Visualizar Formulário Aplicado ---

        function openFillFormModal(formDefinition, patientId, appliedFormInstance = null, isViewOnly = false) {
            fillFormModal.classList.add('active');
            closeApplyFormModalBtn.click(); // Fecha o modal de aplicação

            currentAppliedFormInstance = appliedFormInstance; // Armazena a instância
            currentFillingFormDefinition = formDefinition; // Armazena a definição do formulário que está sendo preenchido/visualizado

            fillFormModalTitle.textContent = isViewOnly ? 'Visualizar Formulário' : 'Preencher Formulário';
            fillFormMainTitle.textContent = formDefinition.mainTitle;
            fillFormDescription.textContent = formDefinition.description;
            fillFormContentArea.innerHTML = ''; // Limpa conteúdo anterior

            saveFilledFormBtn.style.display = isViewOnly ? 'none' : 'inline-block';
            cancelFillFormBtn.textContent = isViewOnly ? 'Fechar' : 'Cancelar';
            printFilledFormBtn.style.display = 'inline-block'; // Sempre mostra o botão de imprimir

            formDefinition.questions.forEach(question => {
                const questionDiv = document.createElement('div');
                questionDiv.classList.add('form-group', 'p-3', 'border', 'border-gray-200', 'rounded-md');

                let inputHtml = '';
                // Garante que questionValue seja um array para checkboxes para evitar erros
                let questionValue = appliedFormInstance && appliedFormInstance.answers[question.id] !== undefined ? appliedFormInstance.answers[question.id] : '';
                // Certifica-se de que, para checkboxes, o valor seja sempre um array para .includes()
                if (question.type === 'checkboxes' && !Array.isArray(questionValue)) {
                    questionValue = [];
                }

                switch (question.type) {
                    case 'short_answer':
                        inputHtml = `<input type="text" class="form-control" data-question-id="${question.id}" value="${questionValue}" ${isViewOnly ? 'disabled' : ''}>`;
                        break;
                    case 'paragraph':
                        inputHtml = `<textarea class="form-control textarea-field" data-question-id="${question.id}" ${isViewOnly ? 'disabled' : ''}>${questionValue}</textarea>`;
                        break;
                    case 'multiple_choice':
                        inputHtml = question.options.map(option => `
                            <div>
                                <input type="radio" name="q_${question.id}" value="${option}" class="mr-2" data-question-id="${question.id}" ${questionValue === option ? 'checked' : ''} ${isViewOnly ? 'disabled' : ''}>
                                <label>${option}</label>
                            </div>
                        `).join('');
                        break;
                    case 'checkboxes':
                        inputHtml = question.options.map(option => `
                            <div>
                                <input type="checkbox" name="q_${question.id}" value="${option}" class="mr-2" data-question-id="${question.id}" ${questionValue.includes(option) ? 'checked' : ''} ${isViewOnly ? 'disabled' : ''}>
                                <label>${option}</label>
                            </div>
                        `).join('');
                        break;
                    case 'dropdown':
                        inputHtml = `
                            <select class="form-control form-select" data-question-id="${question.id}" ${isViewOnly ? 'disabled' : ''}>
                                <option value="">Selecione uma opção</option>
                                ${question.options.map(option => `<option value="${option}" ${questionValue === option ? 'selected' : ''}>${option}</option>`).join('')}
                            </select>
                        `;
                        break;
                    case 'linear_scale':
                        const minVal = question.options[0] || 1;
                        const maxVal = question.options[1] || 5;
                        const currentVal = questionValue !== '' ? questionValue : minVal;
                        inputHtml = `
                            <div class="flex items-center gap-2">
                                <span>${question.options[2] || minVal}</span>
                                <input type="range" min="${minVal}" max="${maxVal}" value="${currentVal}" class="flex-grow" data-question-id="${question.id}" ${isViewOnly ? 'disabled' : ''}>
                                <span>${question.options[3] || maxVal}</span>
                            </div>
                            <div class="text-center mt-1 text-sm text-gray-600">Valor selecionado: <span id="linearScaleValue_${question.id}">${currentVal}</span></div>
                        `;
                        break;
                    case 'date':
                        inputHtml = `<input type="date" class="form-control" data-question-id="${question.id}" value="${questionValue}" ${isViewOnly ? 'disabled' : ''}>`;
                        break;
                    case 'time':
                        inputHtml = `<input type="time" class="form-control" data-question-id="${question.id}" value="${questionValue}" ${isViewOnly ? 'disabled' : ''}>`;
                        break;
                }

                questionDiv.innerHTML = `
                    <label class="form-label">${question.text} ${question.required ? '<span class="text-red-500">*</span>' : ''}</label>
                    ${inputHtml}
                `;
                fillFormContentArea.appendChild(questionDiv);

                // Adiciona listener para atualizar o valor da escala linear
                if (question.type === 'linear_scale' && !isViewOnly) {
                    const rangeInput = questionDiv.querySelector(`input[type="range"]`);
                    const valueSpan = questionDiv.querySelector(`#linearScaleValue_${question.id}`);
                    if (rangeInput && valueSpan) {
                        rangeInput.addEventListener('input', (e) => {
                            valueSpan.textContent = e.target.value;
                        });
                    }
                }
            });
        }

        closeFillFormModalBtn.addEventListener('click', () => fillFormModal.classList.remove('active'));
        cancelFillFormBtn.addEventListener('click', () => fillFormModal.classList.remove('active'));
        fillFormModal.addEventListener('click', (e) => {
            if (e.target === fillFormModal) {
                fillFormModal.classList.remove('active');
            }
        });
        saveFilledFormBtn.addEventListener('click', saveFilledForm);
        printFilledFormBtn.addEventListener('click', () => preparePrintFilledForm(currentAppliedFormInstance));


        async function saveFilledForm() {
            // Usa currentFillingFormDefinition em vez de currentEditingForm
            if (!currentFillingFormDefinition) {
                await showAlert('Erro: Definição do formulário não encontrada.', 'Erro');
                return;
            }

            const answers = {};
            let isValid = true;

            for (const question of currentFillingFormDefinition.questions) { // Use for...of for async/await with showAlert
                const questionElements = fillFormContentArea.querySelectorAll(`[data-question-id="${question.id}"]`);
                let answer;

                switch (question.type) {
                    case 'short_answer':
                    case 'paragraph':
                    case 'date':
                    case 'time':
                        answer = questionElements[0] ? questionElements[0].value.trim() : '';
                        break;
                    case 'multiple_choice':
                    case 'dropdown':
                    case 'linear_scale':
                        answer = questionElements[0] ? questionElements[0].value : '';
                        break;
                    case 'checkboxes':
                        // Coleta todos os checkboxes com o mesmo data-question-id
                        answer = Array.from(fillFormContentArea.querySelectorAll(`input[type="checkbox"][data-question-id="${question.id}"]`))
                            .filter(el => el.checked)
                            .map(el => el.value);
                        break;
                }

                if (question.required && (answer === '' || (Array.isArray(answer) && answer.length === 0))) {
                    isValid = false;
                    await showAlert(`A pergunta "${question.text}" é obrigatória e não foi preenchida.`, 'Erro de Validação');
                    return; // Retorna aqui para parar a validação após o primeiro erro
                }
                answers[question.id] = answer;
            }

            if (!isValid) return; // Se isValid for falso, já foi exibido um alerta e a função foi interrompida

            const now = new Date();
            const filledFormId = currentAppliedFormInstance ? currentAppliedFormInstance.id : `FILLED-${now.getTime()}-${Math.floor(Math.random() * 1000)}`;

            const filledFormObject = {
                id: filledFormId,
                patientId: currentPatientId,
                formId: currentFillingFormDefinition.id, // Usa currentFillingFormDefinition
                formFileName: currentFillingFormDefinition.fileName, // Usa currentFillingFormDefinition
                formMainTitle: currentFillingFormDefinition.mainTitle, // Usa currentFillingFormDefinition
                appliedDate: now.toISOString().split('T')[0],
                answers: answers
            };

            if (currentAppliedFormInstance) {
                // Atualiza uma instância existente
                const index = appliedForms.findIndex(af => af.id === filledFormId);
                if (index !== -1) {
                    appliedForms[index] = filledFormObject;
                }
            } else {
                // Adiciona uma nova instância
                appliedForms.push(filledFormObject);
            }

            localStorage.setItem('appliedForms', JSON.stringify(appliedForms));
            await showAlert('Formulário preenchido salvo com sucesso!', 'Sucesso'); // Exibe alerta de sucesso
            fillFormModal.classList.remove('active'); // Fecha o modal após o alerta
            renderPatientAppliedForms(currentPatientId); // Atualiza a lista de formulários aplicados
        }


        function preparePrintFilledForm(appliedFormInstance) {
            if (!appliedFormInstance) {
                showAlert('Nenhum formulário preenchido para imprimir.', 'Aviso');
                return;
            }

            const formDefinition = forms.find(f => f.id === appliedFormInstance.formId);
            const patient = patients.find(p => p.id === appliedFormInstance.patientId);

            if (!formDefinition) {
                showAlert('Definição do formulário original não encontrada. Pode ter sido excluída.', 'Erro de Impressão');
                return;
            }
            if (!patient) {
                showAlert('Dados do paciente não encontrados. O paciente pode ter sido excluído.', 'Erro de Impressão');
                return;
            }

            let printContentHtml = `
                <div class="form-print-section">
                    <h3>Formulário: ${formDefinition.mainTitle}</h3>
                    <p class="text-gray-600">${formDefinition.description}</p>
                    <p class="text-sm text-gray-700">Paciente: ${patient.fullName} (ID: ${patient.id})</p>
                    <p class="text-sm text-gray-700">Data de aplicação: ${formatDate(appliedFormInstance.appliedDate)}</p>
                </div>
                <div class="mt-4">             
            `;

            formDefinition.questions.forEach(question => {
                const answer = appliedFormInstance.answers[question.id];
                let answerDisplay = 'Não respondido';

                if (answer !== undefined && answer !== null && answer !== '') {
                    if (Array.isArray(answer)) {
                        answerDisplay = answer.length > 0 ? answer.join(', ') : 'Nenhuma opção selecionada';
                    } else if (question.type === 'date') {
                        answerDisplay = formatDate(answer);
                    } else {
                        answerDisplay = answer;
                    }
                }

                printContentHtml += `
                    <div class="form-question-print">
                        <p class="question-text">${question.text}</p>
                        <p class="answer-text">Resposta: ${answerDisplay}</p>
                    </div>
                `;
            });

            printContentHtml += `</div>`;

            preparePrintContent(printContentHtml, "Imprimir Formulário Aplicado"); // Usa a nova função
        }


        // --- Funções de Gerenciamento de Sessões ---

        function openSessionManagementModal(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) {
                showAlert('Paciente não encontrado.', 'Erro');
                return;
            }
            currentSessionPatientId = patientId;
            sessionPatientName.textContent = patient.fullName;

            // Preencher campos com dados existentes
            const sessionPlan = patient.sessionPlan;
            totalSessionsInput.value = sessionPlan.totalSessions || '';
            sessionsPerWeekInput.value = sessionPlan.sessionsPerWeek || '';
            sessionStartDateInput.value = sessionPlan.startDate || '';

            fixedTimesContainer.innerHTML = '';
            if (sessionPlan.fixedTimes && sessionPlan.fixedTimes.length > 0) {
                sessionPlan.fixedTimes.forEach(timeSlot => addFixedTimeField(timeSlot.dayOfWeek, timeSlot.time));
            } else {
                addFixedTimeField(); // Adiciona um campo vazio se não houver horários fixos
            }

            sessionManagementModal.classList.add('active');
        }

        closeSessionManagementModalBtn.addEventListener('click', closeSessionManagementModal);
        cancelSessionManagementBtn.addEventListener('click', closeSessionManagementModal);
        sessionManagementModal.addEventListener('click', (e) => {
            if (e.target === sessionManagementModal) {
                closeSessionManagementModal();
            }
        });
        addFixedTimeBtn.addEventListener('click', () => addFixedTimeField());
        saveSessionManagementBtn.addEventListener('click', saveSessionPlanAndSchedule);


        function closeSessionManagementModal() {
            sessionManagementModal.classList.remove('active');
            currentSessionPatientId = null;
        }

        function addFixedTimeField(dayOfWeek = '', time = '') {
            const newFixedTimeDiv = document.createElement('div');
            newFixedTimeDiv.classList.add('flex', 'items-center', 'gap-2', 'fixed-time-row');
            newFixedTimeDiv.innerHTML = `
                <select class="form-control form-select fixed-time-day">
                    <option value="">Selecione o Dia</option>
                    <option value="0">Domingo</option>
                    <option value="1">Segunda-feira</option>
                    <option value="2">Terça-feira</option>
                    <option value="3">Quarta-feira</option>
                    <option value="4">Quinta-feira</option>
                    <option value="5">Sexta-feira</option>
                    <option value="6">Sábado</option>
                </select>
                <input type="time" class="form-control fixed-time-time" value="${time}">
                <button type="button" class="btn btn-danger btn-sm remove-fixed-time-btn">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            `;
            newFixedTimeDiv.querySelector('.fixed-time-day').value = String(dayOfWeek); // Garante que o valor seja string

            newFixedTimeDiv.querySelector('.remove-fixed-time-btn').addEventListener('click', function() {
                newFixedTimeDiv.remove();
            });
            fixedTimesContainer.appendChild(newFixedTimeDiv);
        }

        async function saveSessionPlanAndSchedule() {
            const patient = patients.find(p => p.id === currentSessionPatientId);
            if (!patient) {
                showAlert('Erro: Paciente não encontrado para salvar o plano de sessões.', 'Erro');
                return;
            }

            const totalSessions = parseInt(totalSessionsInput.value);
            const sessionsPerWeek = parseInt(sessionsPerWeekInput.value);
            const startDate = sessionStartDateInput.value;
            const fixedTimes = [];

            fixedTimesContainer.querySelectorAll('.fixed-time-row').forEach(row => {
                const dayOfWeek = parseInt(row.querySelector('.fixed-time-day').value);
                const time = row.querySelector('.fixed-time-time').value;
                if (!isNaN(dayOfWeek) && time) {
                    fixedTimes.push({ dayOfWeek, time });
                }
            });

            if (isNaN(totalSessions) || totalSessions <= 0) {
                await showAlert('Por favor, insira um número válido para "Total de Sessões".', 'Erro de Validação');
                return;
            }
            if (isNaN(sessionsPerWeek) || sessionsPerWeek <= 0) {
                await showAlert('Por favor, insira um número válido para "Sessões por Semana".', 'Erro de Validação');
                return;
            }
            if (!startDate) {
                await showAlert('Por favor, selecione uma "Data de Início".', 'Erro de Validação');
                return;
            }
            if (fixedTimes.length === 0) {
                await showAlert('Por favor, adicione pelo menos um "Horário Fixo".', 'Erro de Validação');
                return;
            }

            patient.sessionPlan = {
                totalSessions: totalSessions,
                sessionsPerWeek: sessionsPerWeek,
                fixedTimes: fixedTimes,
                startDate: startDate,
                scheduledAppointments: [] // Limpa agendamentos anteriores ao recalcular
            };

            // Gerar e agendar sessões
            await generateAndScheduleAppointments(patient); // Aguarda a conclusão do agendamento

            localStorage.setItem('patients', JSON.stringify(patients));
            await showAlert('Plano de sessões salvo e agendamentos gerados!', 'Sucesso');
            closeSessionManagementModal();
            renderTimeSlots(); // Atualiza a agenda
            renderCalendar(); // Atualiza o calendário
        }

        // Função para converter "HH:MM" para minutos a partir da meia-noite
        function convertTimeToMinutes(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        }

        async function generateAndScheduleAppointments(patient) { // Marcado como assíncrono
            const { totalSessions, sessionsPerWeek, fixedTimes, startDate } = patient.sessionPlan;
            let sessionsScheduled = 0;
            let currentDateIter = new Date(startDate + 'T00:00:00'); // Data atual para iteração

            // Limpa agendamentos antigos para este paciente
            for (const dateKey in appointments) {
                // Cria uma cópia das chaves para deletar com segurança durante a iteração
                const timeKeysToDelete = Object.keys(appointments[dateKey]).filter(timeKey =>
                    appointments[dateKey][timeKey] && appointments[dateKey][timeKey].patientId === patient.id
                );
                timeKeysToDelete.forEach(timeKey => {
                    delete appointments[dateKey][timeKey];
                });
                // Remove a entrada da data se não houver mais agendamentos para aquele dia
                if (Object.keys(appointments[dateKey]).length === 0) {
                    delete appointments[dateKey];
                }
            }

            const conflictMessages = []; // Para coletar mensagens de conflito para um único alerta no final

            // Loop através das semanas até que o total de sessões seja agendado
            while (sessionsScheduled < totalSessions) {
                let sessionsThisWeek = 0;
                let tempDate = new Date(currentDateIter); // Data temporária para iterar os dias dentro de uma semana

                for (let i = 0; i < 7; i++) { // Itera pelos 7 dias da semana
                    if (sessionsThisWeek >= sessionsPerWeek || sessionsScheduled >= totalSessions) {
                        break; // Para se as sessões semanais/totais forem atingidas
                    }

                    const dayOfWeek = tempDate.getDay(); // 0 = Domingo, 1 = Segunda...
                    const appointmentDateKey = tempDate.toISOString().split('T')[0];

                    for (const fixedTime of fixedTimes) { // Usa for...of para permitir `await` e `continue`
                        if (sessionsScheduled >= totalSessions) break; // Verifica novamente se o total de sessões foi atingido

                        if (fixedTime.dayOfWeek === dayOfWeek) {
                            const appointmentTimeKey = fixedTime.time;

                            // Verifica se o slot já está ocupado por *qualquer* paciente
                            if (appointments[appointmentDateKey] && appointments[appointmentDateKey][appointmentTimeKey]) {
                                // Slot está ocupado por outro paciente
                                const existingPatientName = appointments[appointmentDateKey][appointmentTimeKey].patientName;
                                conflictMessages.push(`Horário ${appointmentTimeKey} em ${new Date(appointmentDateKey).toLocaleDateString('pt-BR')} já está ocupado por ${existingPatientName}.`);
                                continue; // Pula este fixedTime, passa para o próximo
                            }

                            // Se não houver conflito, agenda a sessão
                            if (!appointments[appointmentDateKey]) {
                                appointments[appointmentDateKey] = {};
                            }
                            appointments[appointmentDateKey][appointmentTimeKey] = {
                                patientId: patient.id,
                                patientName: patient.fullName,
                                status: { confirmed: false, absence: false }
                            };
                            patient.sessionPlan.scheduledAppointments.push({
                                date: appointmentDateKey,
                                time: appointmentTimeKey
                            });
                            sessionsScheduled++;
                            sessionsThisWeek++;
                        }
                    }
                    tempDate.setDate(tempDate.getDate() + 1); // Avança para o próximo dia
                }
                // Avança para o início da próxima semana, mantendo o offset do dia de início
                currentDateIter.setDate(currentDateIter.getDate() + (7 - (currentDateIter.getDay() - new Date(startDate + 'T00:00:00').getDay() + 7) % 7));
            }

            localStorage.setItem('appointments', JSON.stringify(appointments));
            localStorage.setItem('patients', JSON.stringify(patients)); // Atualiza scheduledAppointments do paciente

            if (conflictMessages.length > 0) {
                const message = "Alguns agendamentos não puderam ser gerados devido a conflitos de horário:\n\n" + conflictMessages.join('\n');
                await showAlert(message, 'Conflito de Horário');
            }
        }

        // === Gerenciador de Exercícios (Therapy App) ===
        // Encapsulando o código do Evox versão final.html em um objeto global para evitar conflitos
        const therapyApp = {
            exercicios: [],
            selecionados: [],
            editandoIndex: null,
            nomeDoPaciente: "",
            exercicioSelecionadoTemp: null,
            exercicioComInformacoes: null,

            init: function() {
                this.exercicios = JSON.parse(localStorage.getItem('exercicios')) || [
                    {
                        nome: "Exercício Exemplo",
                        descricao: "Este é um exercício de exemplo.\nPode ser editado ou excluído.",
                        informacoes: ""
                    }
                ];
                therapyBotaoEnviarExercicio.addEventListener('click', () => this.enviarExercicio());
                this.renderizarSelecionados();
            },

            setPatient: function(patient) {
                if (patient) {
                    this.nomeDoPaciente = patient.fullName;
                    therapyPatientDisplay.textContent = `Paciente: ${patient.fullName}`;
                    therapyPatientDisplay.classList.remove('hidden');
                    therapyCurrentPatientId = patient.id; // Define o ID do paciente cadastrado
                } else {
                    this.nomeDoPaciente = "";
                    therapyPatientDisplay.classList.add('hidden');
                    therapyCurrentPatientId = null; // Limpa o ID do paciente
                }
                // Limpa os exercícios selecionados ao mudar de paciente
                this.selecionados = [];
                this.renderizarSelecionados();
            },

            // Funções para os Modais
            abrirModalBusca: function() {
                therapyModalBusca.classList.remove('hidden');
                this.renderizarLista();
            },

            fecharModalBusca: function() {
                therapyModalBusca.classList.add('hidden');
            },

            abrirModalCadastro: function(limpar = true) {
                therapyModalCadastro.classList.remove('hidden');
                if (limpar) {
                    therapyCadNome.value = '';
                    therapyCadDescricao.value = '';
                    this.editandoIndex = null;
                }
            },

            fecharModalCadastro: function() {
                therapyModalCadastro.classList.add('hidden');
            },

            abrirModalPaciente: function() {
                therapyModalPaciente.classList.remove('hidden');
                therapyNomePaciente.value = this.nomeDoPaciente;
            },

            fecharModalPaciente: function() {
                therapyModalPaciente.classList.add('hidden');
            },

            abrirModalInformacoes: function(index) {
                this.exercicioComInformacoes = index;
                therapyTextoInformacoes.value = this.exercicios[index].informacoes || '';
                therapyModalInformacoes.classList.remove('hidden');
            },

            fecharModalInformacoes: function() {
                therapyModalInformacoes.classList.add('hidden');
            },

            selecionarExercicio: function(index) {
                this.exercicioSelecionadoTemp = this.exercicios[index];
                therapyTituloModalExercicio.textContent = this.exercicioSelecionadoTemp.nome;
                
                // SEMPRE limpar os campos quando um novo exercício é selecionado
                therapyInputSeries.value = '';
                therapyInputRepeticoes.value = '';
                therapyInputDescanso.value = '';
                
                therapyModalDetalhesExercicio.classList.remove('hidden');
            },

            fecharModalDetalhes: function() {
                therapyModalDetalhesExercicio.classList.add('hidden');
            },

            // Funções de manipulação de dados
            salvarPaciente: async function() { // Tornar async para usar showAlert
                this.nomeDoPaciente = therapyNomePaciente.value.trim();
                this.fecharModalPaciente();
                await showAlert('Nome do paciente definido. Lembre-se que para salvar a terapia, você precisa selecionar um paciente cadastrado.', 'Informação');
            },

            salvarNovoExercicio: async function() { // Tornar async para usar showAlert
                const nome = therapyCadNome.value.trim();
                const descricao = therapyCadDescricao.value.trim();

                if (!nome || !descricao) {
                    await showAlert("Nome e descrição são obrigatórios.", "Erro de Validação");
                    return;
                }

                const novoExercicio = {
                    nome,
                    descricao,
                    informacoes: ""
                };

                if (this.editandoIndex !== null) {
                    this.exercicios[this.editandoIndex] = novoExercicio;
                } else {
                    this.exercicios.push(novoExercicio);
                }

                this.salvarExercicios();
                this.fecharModalCadastro(); // Fecha o modal primeiro
                await showAlert('Exercício salvo com sucesso!', 'Sucesso'); // Em seguida, exibe o alerta
                this.renderizarLista();
            },

            salvarInformacoes: async function() { // Tornar async para usar showAlert
                const informacoes = therapyTextoInformacoes.value.trim();
                this.exercicios[this.exercicioComInformacoes].informacoes = informacoes;
                this.salvarExercicios();
                this.fecharModalInformacoes(); // Fecha o modal primeiro
                await showAlert('Informações salvas com sucesso!', 'Sucesso'); // Em seguida, exibe o alerta
                this.renderizarLista();
            },

            editarExercicio: function(index) {
                const ex = this.exercicios[index];
                therapyCadNome.value = ex.nome;
                therapyCadDescricao.value = ex.descricao;
                this.editandoIndex = index;
                this.abrirModalCadastro(false);
            },

            salvarExercicios: function() {
                localStorage.setItem('exercicios', JSON.stringify(this.exercicios));
            },

            enviarExercicio: function() {
                const series = therapyInputSeries.value.trim();
                const repeticoes = therapyInputRepeticoes.value.trim();
                const descanso = therapyInputDescanso.value.trim();
                
                const descricaoExtra = [
                    series ? `Séries: ${series}` : '',
                    repeticoes ? `Repetições: ${repeticoes}` : '',
                    descanso ? `Descanso: ${descanso}` : ''
                ].filter(Boolean).join(' | ');
                
                const descricaoCompleta = descricaoExtra
                    ? `${this.exercicioSelecionadoTemp.descricao}\n\n${descricaoExtra}`
                    : this.exercicioSelecionadoTemp.descricao;
                
                this.selecionados.push({
                    nome: this.exercicioSelecionadoTemp.nome,
                    descricao: descricaoCompleta
                });
                
                this.renderizarSelecionados();
                this.fecharModalDetalhes();
            },

            // Nova função para salvar a terapia selecionada
            saveSelectedTherapy: async function() {
                if (!therapyCurrentPatientId) {
                    await showAlert("Para salvar uma terapia, você precisa selecionar um paciente cadastrado através do Prontuário.", "Aviso");
                    return;
                }

                if (this.selecionados.length === 0) {
                    await showAlert("Não há exercícios selecionados para salvar.", "Aviso");
                    return;
                }

                const patient = patients.find(p => p.id === therapyCurrentPatientId);
                if (!patient) {
                    await showAlert("Paciente cadastrado não encontrado. Por favor, recarregue e tente novamente.", "Erro");
                    return;
                }

                const newTherapy = {
                    id: `TERAPY-${Date.now()}-${Math.floor(Math.random() * 1000)}`,
                    patientId: patient.id,
                    patientName: patient.fullName,
                    date: new Date().toISOString().split('T')[0],
                    exercises: JSON.parse(JSON.stringify(this.selecionados)) // Copia profunda
                };

                savedPatientTherapies.push(newTherapy);
                localStorage.setItem('savedPatientTherapies', JSON.stringify(savedPatientTherapies));
                await showAlert(`Terapia para ${patient.fullName} salva com sucesso!`, "Sucesso");
            },

            // Funções de renderização
            renderizarLista: function(filtro = '') {
                const lista = therapyListaExercicios;
                lista.innerHTML = '';
                
                const exerciciosFiltrados = this.exercicios
                    .map((ex, idx) => ({ ...ex, index: idx }))
                    .filter(ex => ex.nome.toLowerCase().includes(filtro.toLowerCase()));
                
                if (exerciciosFiltrados.length === 0) {
                    lista.innerHTML = '<div class="text-center py-4 text-gray-500">Nenhum exercício encontrado</div>';
                    return;
                }

                exerciciosFiltrados.forEach((ex, i) => {
                    const div = document.createElement('div');
                    div.className = 'border p-3 rounded-lg bg-gray-100 flex justify-between items-center';
                    div.innerHTML = `
                        <div onclick="therapyApp.selecionarExercicio(${ex.index})" class="cursor-pointer hover:underline flex-1">
                            <strong class="text-sm sm:text-base">${i + 1}. ${ex.nome}</strong><br>
                            <span class="text-xs text-gray-600 descricao-limitada">${ex.descricao}</span>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="therapyApp.abrirModalInformacoes(${ex.index})" class="text-xs sm:text-sm text-white bg-black px-2 py-1 rounded-lg hover:bg-gray-800 flex items-center">
                                <svg class="h-3 w-3 sm:h-4 sm:w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                            </button>
                            <button onclick="therapyApp.editarExercicio(${ex.index})" class="text-xs sm:text-sm text-white bg-black px-2 py-1 rounded-lg hover:bg-gray-800">Editar</button>
                            <button onclick="therapyApp.confirmarExclusao(${ex.index})" class="text-xs sm:text-sm text-white bg-black px-2 py-1 rounded-lg hover:bg-gray-800">Excluir</button>
                        </div>
                    `;
                    lista.appendChild(div);
                });
            },

            renderizarSelecionados: function() {
                const div = therapyExercicioSelecionado;
                div.innerHTML = '';
                
                if (this.selecionados.length === 0) {
                    div.innerHTML = '<div class="text-center py-4 text-gray-500">Nenhum exercício selecionado</div>';
                    return;
                }

                this.selecionados.forEach((ex, i) => {
                    const bloco = document.createElement('div');
                    bloco.className = 'bg-white border rounded-lg p-3 shadow flex justify-between items-start mb-2';
                    bloco.innerHTML = `
                        <div class="flex-1">
                            <strong class="text-sm sm:text-base">${ex.nome}</strong><br>
                            <span class="text-xs sm:text-sm text-gray-700">${ex.descricao.replace(/\n/g, '<br>')}</span>
                        </div>
                        <button onclick="therapyApp.excluirSelecionadoIndividual(${i})" class="text-red-500 hover:text-red-700 text-lg">🗑️</button>
                    `;
                    div.appendChild(bloco);
                });
            },

            // Outras funções
            confirmarExclusao: function(index) {
                // Usando showAlert para a confirmação
                showAlert('Tem certeza que deseja excluir este exercício?', 'Confirmação')
                    .then(async confirmed => { // Tornar async para usar await com showAlert
                        if (confirmed) {
                            this.exercicios.splice(index, 1);
                            this.salvarExercicios();
                            this.renderizarLista();
                            await showAlert('Exercício excluído com sucesso!', 'Sucesso'); // Exibe alerta de sucesso
                        }
                    });
            },

            copiarTexto: function() {
                const texto = this.selecionados.map(ex => `${ex.nome}\n${ex.descricao}`).join('\n\n');
                // Substituir navigator.clipboard.writeText por document.execCommand('copy')
                const el = document.createElement('textarea');
                el.value = texto;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                showAlert('Exercícios copiados!', 'Sucesso');
            },

            imprimirTexto: function() {
                const janela = window.open('', '', 'width=800,height=600');
                const conteudo = this.selecionados.map((ex, i) => {
                    return `
                    <div style="border:1px solid #000;padding:8px;margin-bottom:10px;">
                        <strong>${i + 1}. ${ex.nome}</strong><br>
                        ${ex.descricao.replace(/\n/g, '<br>')}
                    </div>`;
                }).join('');
                
                const dataAtual = new Date().toLocaleDateString();
                janela.document.write(`
                    <html>
                        <head>
                            <title>Impressão</title>
                            <style>
                                body { font-family: sans-serif; padding: 10px; }
                                div { margin-bottom: 10px; }
                                .footer { margin-top: 30px; font-size: 12px; text-align: center; color: #666; }
                                .logo-container { text-align: center; margin-bottom: 20px; }
                                .logo-svg { width: 150px; height: auto; }
                                .slogan { font-family: 'Poppins', sans-serif; font-weight: 500; font-size: 1.25rem; color: #333; margin-top: 0.5rem; }
                            </style>
                        </head>
                        <body>
                            <div class="logo-container">
                                <svg class="logo-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 357 175.5">
                                    <defs>
                                        <clipPath id="c5645058c6_print">
                                            <path d="M 98.429688 39.652344 L 186.332031 39.652344 L 186.332031 114.601562 L 98.429688 114.601562 Z M 98.429688 39.652344 " clip-rule="nonzero"/>
                                        </clipPath>
                                    </defs>
                                    <g fill="#000000" fill-opacity="1">
                                        <g transform="translate(25.653129, 111.017463)">
                                            <g>
                                                <path d="M 8.394531 0 L 8.394531 -73.464844 L 61.816406 -73.464844 L 61.816406 -68.847656 L 13.222656 -68.847656 L 13.222656 -39.566406 L 54.574219 -39.566406 L 54.574219 -35.367188 L 13.222656 -35.367188 L 13.222656 -4.617188 L 63.074219 -4.617188 L 63.074219 0 Z M 8.394531 0 "/>
                                            </g>
                                        </g>
                                    </g>
                                    <g fill="#000000" fill-opacity="1">
                                        <g transform="translate(94.499918, 111.017463)">
                                            <g/>
                                        </g>
                                    </g>
                                    <g fill="#000000" fill-opacity="1">
                                        <g transform="translate(122.8353, 111.017463)">
                                            <g/>
                                        </g>
                                    </g>
                                    <g fill="#000000" fill-opacity="1">
                                        <g transform="translate(151.170682, 111.017463)">
                                            <g/>
                                        </g>
                                    </g>
                                    <g fill="#000000" fill-opacity="1">
                                        <g transform="translate(179.520629, 111.017463)">
                                            <g>
                                                <path d="M 42.398438 1.257812 C 37.152344 1.257812 32.289062 0.332031 27.8125 -1.523438 C 23.332031 -3.375 19.449219 -6 16.164062 -9.394531 C 12.875 -12.785156 10.320312 -16.792969 8.5 -21.410156 C 6.683594 -26.027344 5.773438 -31.101562 5.773438 -36.628906 C 5.773438 -42.15625 6.683594 -47.246094 8.5 -51.898438 C 10.320312 -56.550781 12.875 -60.574219 16.164062 -63.96875 C 19.449219 -67.359375 23.332031 -69.984375 27.8125 -71.839844 C 32.289062 -73.691406 37.152344 -74.621094 42.398438 -74.621094 C 47.71875 -74.621094 52.613281 -73.691406 57.09375 -71.839844 C 61.570312 -69.984375 65.453125 -67.359375 68.742188 -63.96875 C 72.03125 -60.574219 74.585938 -56.550781 76.402344 -51.898438 C 78.222656 -47.246094 79.132812 -42.15625 79.132812 -36.628906 C 10.601562 -30.191406 11.980469 -24.453125 14.746094 -19.414062 C 17.507812 -14.378906 21.289062 -10.441406 26.078125 -7.609375 C 30.871094 -4.773438 36.3125 -3.359375 42.398438 -3.359375 Z M 42.398438 -3.359375 "/>
                                            </g>
                                        </g>
                                    </g>
                                    <g clip-path="url(#c5645058c6_print)">
                                        <path fill="#000000" d="M 105.382812 39.652344 L 116.570312 58.839844 L 122.152344 68.285156 L 127.738281 77.957031 L 139.011719 97.089844 L 144.523438 106.605469 L 145.824219 108.734375 L 142.382812 114.601562 L 141.082031 112.472656 L 129.898438 93.355469 L 118.710938 74.167969 L 98.484375 39.652344 Z M 175.9375 45.585938 L 167.121094 45.585938 L 150.421875 74.148438 L 146.980469 68.285156 L 163.75 39.652344 L 186.28125 39.652344 L 150.195312 101.28125 L 114.109375 39.652344 L 121.011719 39.652344 L 150.195312 89.546875 Z M 175.9375 45.585938 " fill-opacity="1" fill-rule="nonzero"/>
                                    </g>
                                </g>
                            </div>
                        </svg>
                                <div class="slogan">Gestão de exercícios terapêuticos</div>
                            </div>
                            ${this.nomeDoPaciente ? `<p style="text-align:center;"><strong>Paciente:</strong> ${this.nomeDoPaciente}</p>` : ''}
                            <p style="text-align:center;"><strong>Data:</strong> ${dataAtual}</p>
                            <div style="margin-top:20px;">
                                ${conteudo}
                            </div>
                            <div class="footer">
                                © 2025 Carlo Felipe Mendes Melo. Todos os direitos reservados.<br>
                                Contato: (61) 9.9934-2573
                            </div>
                        </body>
                    </html>
                `);
                janela.document.close();
                janela.print();
            },

            removerSelecionado: function() {
                // Usando showAlert para a confirmação
                showAlert('Deseja remover todos os exercícios selecionados?', 'Confirmação')
                    .then(async confirmed => { // Tornar async para usar await com showAlert
                        if (confirmed) {
                            this.selecionados = [];
                            this.renderizarSelecionados();
                            await showAlert('Exercícios removidos com sucesso!', 'Sucesso'); // Exibe alerta de sucesso
                        }
                    });
            },

            excluirSelecionadoIndividual: function(index) {
                this.selecionados.splice(index, 1);
                this.renderizarSelecionados();
            },

            filtrarExercicios: function() {
                const valor = therapyCampoBusca.value.trim();
                this.renderizarLista(valor);
            },

            fazerBackup: async function() { // Tornar async para usar await com showAlert
                const dados = JSON.stringify(this.exercicios);
                const blob = new Blob([dados], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup-exercicios-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                await showAlert('Backup de exercícios exportado com sucesso!', 'Sucesso'); // Exibe alerta de sucesso
            },

            importarBackup: function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = async event => { // Tornar async para usar await com showAlert
                        try {
                            const dados = JSON.parse(event.target.result);
                            if (!Array.isArray(dados)) {
                                throw new Error('Formato de arquivo inválido');
                            }
                            
                            // Usando showAlert para a confirmação
                            const confirmed = await showConfirm(`Deseja importar ${dados.length} exercício(s)? Isso substituirá seus exercícios atuais.`, 'Confirmação'); // Usar await
                            if (confirmed) {
                                this.exercicios = dados;
                                this.salvarExercicios();
                                this.renderizarLista();
                                await showAlert('Backup importado com sucesso!', 'Sucesso'); // Exibe alerta de sucesso
                            }
                        } catch (error) {
                            await showAlert('Erro ao importar backup: ' + error.message, 'Erro');
                        }
                    };
                    reader.readAsText(file);
                };
                
                input.click();
            }
        };

    </script>
</body>
</html>